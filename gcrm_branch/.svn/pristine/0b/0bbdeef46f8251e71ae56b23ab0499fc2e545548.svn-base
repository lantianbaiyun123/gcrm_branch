define(["app","../_common/ytCommon","anuglar-ui-select2"],function(t){t.registerController("CtrlAd2",["$scope","$stateParams","$filter","PageSet","Select2Suggest","CURRENT_USER_NAME","AdProgram","Customer","Industry",function(t,e,a,o,n,r,s,i,c){function u(){d()}function d(){t.optionOperator=n.getOperatorOption(),t.optionCustomer=n.getCustomerOption(),t.optionContract=n.getContractOption(t),t.solutionId?(o.set({siteName:"adSolutionDetail",activeIndex:1}),s.getDetail({id:t.solutionId}).success(function(e){if(200===e.code){var a=e.data;t.basicReview=!0,t.basicReviewData={customerI18nView:a.customerI18nView,contract:a.contract,hasContract:a.hasContract||a.contract,operatorName:a.account.name,solutionStatus:a.adSolution.approvalStatus,solutionType:a.adSolution.type,solutionNumber:a.adSolution.number},"direct"===t.basicReviewData.customerI18nView.customer.customerType&&(t.stateCustomerStraight=!0,t.customerStraight={data:a.customerI18nView.customer.customerNumber,value:a.customerI18nView.customer.companyName}),a.adSolution&&a.adSolution.taskInfo&&(t.alerts=[{type:"info",msg:a.adSolution.taskInfo}],"refused"===a.adSolution.approvalStatus&&(t.alerts[0].type="danger")),"update"===a.adSolution.type&&(t.adSolutionTypeUpdate=!0),a.oldSolutionNumber&&(t.oldSolutionNumber=a.oldSolutionNumber),t.newDetailContents=angular.copy(a.approvalContentViews),l()}})):(o.set({siteName:"adSolutionAdd",activeIndex:1}),t.basic.hasContract=!1,t.basic.adProjectStatus=1,t.basic.operatorSelected={data:{ucid:r.ucid,name:r.realname}},t.solutionStatus=a("translate")("AD_BASIC_STATUS_WAITED"),t.solutionType=a("translate")("AD_BASIC_TYPE_NEW"),t.solutionStatus="saving",t.solutionType="create",e.customerNumber&&i.get({customerNumber:e.customerNumber,companyName:""}).success(function(e){t.basic.customerInfo=e.data,t.basic.customerSelected={data:e.data.customer.customerNumber,value:e.data.customer.companyName},"nondirect"===e.data.customer.customerType&&(t.basic.customerSelected={data:e.data.customer.customerNumber,value:e.data.agentCompany.companyName})}))}function l(){b(),t.newDetailContents.length?t.ads=m():$rootScope.BtnIndex.btn_adsol_detail_cont_save&&(t.addAd(),t.anchorTo(0))}function m(){for(var e=[],a=t.newDetailContents,o=0;o<a.length;o++){var n={review:!0};n.reviewData=a[o],n.reviewData.materialType=~~p(a[o].positionVOList,a[o].adSolutionContent.positionId,"materialType"),n.reviewData.positionByAreaSelection=a[o].position,n.canUpdate=a[o].canUpdate,e.push(n)}return e}function p(t,e,a){var o=0;if(t=t||[],3==arguments.length){for(;o<t.length;o++)if(t[o].id==e)return t[o][a]?t[o][a]:""}else for(;o<t.length;o++)if(t[o].id==e)return t[o]}function b(){c.getIndustryTypes().success(function(e){if(200===e.code){for(var a={},o=e.data.length,n=0;o>n;n++){var r=e.data[n].industryTypeName;if(a[r]=[],"subIndustryType"in e.data[n])for(var s=e.data[n].subIndustryType.length,i=0;s>i;i++)a[r].push(e.data[n].subIndustryType[i]);else a[r].push(e.data[n])}t.industry={industryTypes:a}}else $log.error("fatal error")})}t.solutionId=e.id,t.ads=[],t.basic=t.basic||{},u(),t.closeAlert=function(e){"info"===e.type&&t.alerts.splice(0,1)},t.basicSave=function(){if(t.basic.basicCheck=!0,!t.basic.customerSelected||!t.basic.customerSelected.data)return t.basic.customerFocus=!0,!1;if(t.basic.checkOperator=!0,!t.basic.operatorSelected||!t.basic.operatorSelected.data)return t.basic.operatorFocus=!0,!1;t.basic.checkContract=!0;var a;if(t.basic.hasContract){if(!t.basic.contract||!t.basic.contract.data)return t.basic.contractFocus=!0,!1;a=t.basic.contract.data.number}s.basicSave({hasContract:t.basic.hasContract,advertiseSolutionView:{advertiseSolution:{id:t.solutionId,contractNumber:a,customerNumber:t.basic.customerSelected.data,operator:t.basic.operatorSelected.data.ucid}}}).success(function(a){if(200===a.code){var o=a.data.advertiseSolutionView.advertiseSolution.id;t.solutionId=o,e.solutionId||(e.solutionId=o,$state.transitionTo($state.current,e,{reload:!0,inherit:!1,notify:!1}))}})},t.addAd=function(){t.ads.push({}),t.stateEditing=!0}}])});