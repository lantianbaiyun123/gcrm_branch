define(["app","../_common/ytCommon","../_directives/ytPositionSelect","./CtrlResourcePositionPropertyModal","./CtrlResourcePositionPictureModal","../_filters/PositionFilter","../_services/Select2Suggest","anuglar-ui-select2","./CtrlResourcePositionImportModal","./CtrlResourcePositionNameModal","../task/schedule/ScheduleModal","../_directives/ytPopoverConfirm"],function(t){t.registerController("CtrlResourcePositionList",["$scope","$log","PageSet","Position","$modal","ScheduleModal","$window","Modal","Select2Suggest","APP_CONTEXT","$state","$filter","STATIC_DIR",function(t,e,o,i,n,r,a,s,c,d,u,l,p){function m(e,o){t.isQuery=!1,y=e,I=o;for(var i=0;i<t.t.adPlatformList.length;i++)if(t.t.adPlatformList[i].id===e){t.t.adPlatformList[i].active=!0;break}}function _(t,e){i.enablePosition({id:t.id}).success(function(o){if(200===o.code){var i;i="position"===t.type?t.name:t[t.type+"Name"],s.success({content:P("RESOURCE_POSITION_ACTIVATE_SUCCESS",{activatedName:i})},e),g()}else 204===o.code&&s.showError(o.errorList)})}function f(t){var e,o,i,n,r;for(e=window.GCRM&&window.GCRM.rights&&window.GCRM.rights.menuCodeList&&window.GCRM.rights.buttonCodeList&&window.GCRM.rights.menuCodeList.length&&window.GCRM.rights.buttonCodeList.length?window.GCRM.rights.buttonCodeList:["btn_pos_list_import","btn_pos_list_add","btn_pos_list_name_mod","btn_pos_list_property_add","btn_pos_list_launch_mod","btn_pos_list_image_mod_add","btn_pos_list_enable_disable","btn_pos_list_property_view","btn_pos_list_launch_view","btn_pos_list_image_view"],o=0;o<t.length;o++){for(r=t[o],i=0;r.modifyButtons&&i<r.modifyButtons.length;i++){switch(r.modifyButtons[i]){case"batchModifyProperty":n="btn_pos_list_property_add";break;case"modifyOccupation":n="btn_pos_list_launch_mod";break;case"addImage":n="btn_pos_list_image_mod_add";break;case"modifyImage":n="btn_pos_list_image_mod_add";break;case"modifyName":n="btn_pos_list_name_mod";break;case"addProperty":n="btn_pos_list_property_add";break;case"modifyProperty":n="btn_pos_list_property_add"}-1===e.indexOf(n)&&(r.modifyButtons.splice(i,1),i-=1)}for(i=0;r.queryButtons&&i<r.queryButtons.length;i++){switch(r.queryButtons[i]){case"viewImage":n="btn_pos_list_image_view";break;case"viewProperty":n="btn_pos_list_property_view";break;case"viewOccupation":n="btn_pos_list_launch_view"}-1===e.indexOf(n)&&(r.queryButtons.splice(i,1),i-=1)}}return t}o.set({siteName:"resourcePositionList",activeIndex:2}),t.positionOpts={byRole:!0};var P=l("translate");t.toggleQueryMore=function(){t.queryMoreShow=!t.queryMoreShow},t.t={},t.q={},t.q.positionNumberOption=c.positionNumSuggest(),i.getPlatformListByRole().success(function(e){200===e.code&&(t.t.adPlatformList=e.data)});var y,I;t.changePlatform=function(o){y=o.id,i.getSiteListByRole({adPlatformId:o.id}).success(function(o){if(200===o.code){t.t.adSiteList=o.data;try{I?(t.changeSite({id:I}),I=void 0):t.changeSite(t.t.adSiteList[0])}catch(i){e.error(i)}}})},t.changeSite=function(e){return e?(t.siteActiveId=e.id,void i.getPositionTreeList({adPlatformId:y,siteId:e.id}).success(function(e){200===e.code&&(t.contentList=f(e.data.content))})):!1},t.btnQuery=function(){O.resetPageNumber(),O.doQuery()},t.$watch("pager.pageNumber",function(t,e){t&&e&&t!==e&&O.doQuery()}),t.setPageSize=function(e){t.pager.pageSize=e,O.resetPageNumber(),O.doQuery()};var O={initQuery:function(){t.pager={pageNumber:1,pageSize:10,pageSizeSlots:[10,20,30,50],totalCount:0}},doQuery:function(){i.getPositionQueryList(this.getQueryParams()).success(function(e){200===e.code&&(t.isQuery=!0,t.contentList=f(e.data.content),t.pager.totalCount=e.data.totalCount,t.pager.totalPages=e.data.totalPages)})},getQueryParams:function(){var e={};return e.positionName=t.q.positionName,t.q.positionNumber&&(e.positionNumber=t.q.positionNumber.data),e.areaRequired=t.q.areaRequired,e.adPlatformId=t.positionSelected.platform.id,e.siteId=t.positionSelected.site.id,e.channelId=t.positionSelected.channel.id,e.areaId=t.positionSelected.area.id,e.positionId=t.positionSelected.position.id,e.pageSize=t.pager.pageSize,e.pageNumber=t.pager.pageNumber,e},resetPageNumber:function(){t.pager.pageNumber=1}};O.initQuery(),t.btnBackToList=function(){t.isQuery=!1},t.btnClick=function(t,e){N[t](e)};var N={viewOccupation:function(t){r.show({readOnly:!0,positionInfo:{positionId:t.id,advertiser:t.advertiser,productName:t.adPlatformName,siteName:t.siteName,channelName:t.channelName,areaName:t.areaName,positionName:t.name,salesAmount:t.salesAmount,rotationType:"yes"===t.rotationType?1:0}})},modifyOccupation:function(t){r.show({positionInfo:{positionId:t.id,advertiser:t.advertiser,productName:t.adPlatformName,siteName:t.siteName,channelName:t.channelName,areaName:t.areaName,positionName:t.name,salesAmount:t.salesAmount,rotationType:"yes"===t.rotationType?1:0}},function(){s.success({content:l("translate")("SCHEDULE_SUBMIT_SUCCESS"),timeOut:3e3})})},viewImage:function(t){a.open(d+"position/viewGuide/"+t.id)},modifyName:function(t){var e=n.open({templateUrl:p+"app/resourcePosition/modifyName.tpl.html",controller:"CtrlResourcePositionNameModal",resolve:{opts:function(){return{rowData:t}}}});e.result.then(function(){g()})},viewProperty:function(t){n.open({templateUrl:p+"app/resourcePosition/addProperty.tpl.html",controller:"CtrlResourcePositionPropertyModal",windowClass:"resource-position-property-modal",resolve:{opts:function(){return{rowData:t,type:"view"}}}})},batchModifyProperty:function(t){var e=n.open({templateUrl:p+"app/resourcePosition/addProperty.tpl.html",controller:"CtrlResourcePositionPropertyModal",windowClass:"resource-position-property-modal",resolve:{opts:function(){return{rowData:t,type:"batch"}}}});e.result.then(function(){g()})},addProperty:function(t){var e=n.open({templateUrl:p+"app/resourcePosition/addProperty.tpl.html",controller:"CtrlResourcePositionPropertyModal",windowClass:"resource-position-property-modal",resolve:{opts:function(){return{rowData:t,type:"add"}}}});e.result.then(function(){g()})},modifyProperty:function(t){var e=n.open({templateUrl:p+"app/resourcePosition/addProperty.tpl.html",controller:"CtrlResourcePositionPropertyModal",windowClass:"resource-position-property-modal",resolve:{opts:function(){return{rowData:t,type:"edit"}}}});e.result.then(function(){g()})},addImage:function(t){var e=n.open({templateUrl:p+"app/resourcePosition/addPicture.tpl.html",controller:"CtrlResourcePositionPictureModal",resolve:{opts:function(){return{rowData:t,type:"add"}}}});e.result.then(function(){g()})},modifyImage:function(t){n.open({templateUrl:p+"app/resourcePosition/addPicture.tpl.html",controller:"CtrlResourcePositionPictureModal",resolve:{opts:function(){return{rowData:t,type:"edit"}}}})},activatePosition:function(t){e.info("activating");var o=n.open({templateUrl:p+"app/resourcePosition/activate.tpl.html",controller:["$scope","$modalInstance",function(t,e){t.ok=function(){e.close("ok")},t.cancel=function(){e.dismiss("cancel")}}]});o.result.then(function(e){"ok"===e&&("position"!==t.type?i.hasPosition({id:t.id}).success(function(e){200===e.code&&(e.data?_(t):s.alert({content:P("RESOURCE_POSITION_LACK_POSITION")}))}):_(t))})},shutdownPosition:function(t){e.info("shutting down"),i.queryUsedAmount({id:t.id}).success(function(e){if(200===e.code){var o=n.open({templateUrl:p+"app/resourcePosition/shutdown.tpl.html",controller:["$scope","$modalInstance","opts","$filter",function(t,e,o,n){t.usedCount=o.usedCount,t.usedCountHint=n("translate")("POSITION_SHUTDOWN_HINT",{usedCount:t.usedCount}),t.ok=function(){i.disablePosition({id:o.rowData.id}).success(function(t){200===t.code&&e.close("ok")})},t.cancel=function(){e.dismiss("cancel")}}],resolve:{opts:function(){return{rowData:t,usedCount:e.data}}}});o.result.then(function(e){if("ok"===e){var o;o="position"===t.type?t.name:t[t.type+"Name"],s.success({content:P("RESOURCE_POSITION_SHUTDOWN_SUCCESS",{shutdownName:o})}),g()}})}})}};t.btnDownloadTemplate=function(){a.open(d+"position/downloadImportTemplate")},t.btnImport=function(){var t=n.open({templateUrl:p+"app/resourcePosition/import.tpl.html",controller:"CtrlResourcePositionImportModal"});t.result.then(function(t){t&&s.success({content:P("RESOURCE_POSITION_IMPORT_SUCCESS")},function(){t.adPlatformId&&t.siteId&&m(t.adPlatformId,t.siteId)})})};var g=function(){t.isQuery?O.doQuery():t.changeSite({id:t.siteActiveId})};t.btnNavAdd=function(){u.go("resourcePositionAdd",{platformId:y,siteId:t.siteActiveId})}}]),t.registerFilter("ResourcePositionListButtonFilter",function(){var t={viewProperty:"RESOURCE_POSITION_BUTTON_VIEWPROPERTY",viewOccupation:"RESOURCE_POSITION_BUTTON_VIEWOCCUPATION",viewImage:"RESOURCE_POSITION_BUTTON_VIEWIMAGE",modifyName:"RESOURCE_POSITION_BUTTON_MODIFYNAME",batchModifyProperty:"RESOURCE_POSITION_BUTTON_BATCHMODIFYPROPERTY",addProperty:"RESOURCE_POSITION_BUTTON_ADDPROPERTY",modifyProperty:"RESOURCE_POSITION_BUTTON_MODIFYPROPERTY",addImage:"RESOURCE_POSITION_BUTTON_ADDIMAGE",modifyImage:"RESOURCE_POSITION_BUTTON_MODIFYIMAGE",modifyOccupation:"RESOURCE_POSITION_BUTTON_MODIFYOCCUPATION"};return function(e){return e in t?t[e]:""}})});