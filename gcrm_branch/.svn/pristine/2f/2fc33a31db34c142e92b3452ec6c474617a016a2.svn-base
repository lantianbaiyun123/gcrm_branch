define(["app"],function(e){e.registerController("CtrlPlatformAddAndEdit",["$scope","Position","opts","$modalInstance","$parse","Modal","$window","$filter",function(e,s,t,a,n,i,c,l){function o(){var n={};if("edit"===t.type&&(n.id=e.platformId),n.businessType=e.radio.businessType,n.i18nData=[{locale:"zh_CN",value:e.input.cnName},{locale:"en_US",value:e.input.enName}],"sales"===e.radio.businessType)n.sites=[{id:0}];else{n.sites=[];for(var l=0;l<e.sites.length;l++)e.sites[l].checked&&n.sites.push({id:e.sites[l].id})}s.savePlatform(n).success(function(e){200===e.code&&("edit"===t.type?(a.close(),i.success({content:u("PLATFORM_LIST_SAVE_SUCCESS")},function(){c.location.reload()})):(a.close(),i.success({content:u("PLATFORM_LIST_ADD_SUCCESS")},function(){c.location.reload()})))})}function r(e,s){for(var t,a=[],i=0;i<e.length;i++){t=!0;var c=e[i];c.validateFunction?t=c.validateFunction(s[c.key]):n(c.key)(s)||(t=!1),a.push(t)}return a}function d(){if(e.stateValidating){for(var s=!1,t="sites",a=0;a<e.sites.length;a++)if(e.sites[a].checked){s=!0;break}s?p(t):g(t)}}var u=l("translate");e.input={},e.radio={},"edit"===t.type?(s.get({id:t.platformId}).success(function(s){200===s.code&&(e.sites=s.data.sites,e.platformId=s.data.id,e.input.cnName=s.data.cnName,e.input.enName=s.data.enName,e.radio.businessType=s.data.businessType)}),e.showPS=!0):s.get({}).success(function(s){if(200===s.code){e.sites=s.data.sites;for(var t=0;t<e.sites.length;t++)e.sites[t].allowCanceled=!0}});var f=[{key:"input.cnName",message:u("PLACEHOLDER_CN_NAME")},{key:"input.enName",message:u("PLACEHOLDER_EN_NAME")},{key:"sites",message:u("PLATFORM_ADD_CHECK_SITE"),validateFunction:function(e){for(var s=!1,t=0;t<e.length&&!s;t++)e[t].checked&&(s=!0);return s},clear:function(){}}];e.businessTypeToggle=function(){e.alerts=[]},e.alerts=[],e.ok=function(){if(e.alerts=[],!e.alerts||!e.alerts.length){e.stateValidating=!0;for(var s=r(f,e),t=!0,a=0;a<f.length&&t;a++)if(s[a])p(f[a].key);else{if("sales"===e.radio.businessType&&"sites"===f[a].key)continue;e.alerts=e.alerts||[],e.alerts.push({type:"danger",msg:f[a].message,key:f[a].key})}e.alerts.length||o()}},e.closeAlert=function(s){e.alerts.splice(s,1)},e.changeCnName=function(){var s="input.cnName";e.stateValidating&&(e.input.cnName?p(s):g(s))},e.changeEnName=function(){var s="input.enName";e.stateValidating&&(e.input.enName?p(s):g(s))};var p=function(s){for(var t=0;t<e.alerts.length;t++)if(e.alerts[t].key===s){e.alerts.splice(t,1);break}},g=function(s){for(var t=0;t<f.length;t++)if(f[t].key===s){e.alerts.push({type:"danger",msg:f[t].message,key:f[t].key});break}};e.toggle=function(){if(e.sites){var s;if(e.check.all)for(s=0;s<e.sites.length;s++)e.sites[s].allowCanceled&&(e.sites[s].checked=!0);else for(s=0;s<e.sites.length;s++)e.sites[s].allowCanceled&&(e.sites[s].checked=!1);d()}},e.check={},e.checkSingle=function(s){s.checked=!s.checked;for(var t=!0,a=0;a<e.sites.length&&t;a++)e.sites[a].allowCanceled&&e.sites[a].checked===!1&&(t=!1);e.check.all=t,d()},e.cancel=function(){a.dismiss("cancel")}}])});