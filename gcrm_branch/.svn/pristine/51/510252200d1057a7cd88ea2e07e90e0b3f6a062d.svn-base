define(["app","../_common/ytCommon","../_directives/ytJqueryFileUpload","../_directives/ytAjaxupload","../_directives/ytPlaceholder","../benchmarkPrice/BenchmarkPriceSubmitModal","../_services/http/BenchmarkPrice"],function(t){t.registerController("CtrlBenchmarkPriceEdit",["$scope","$state","$log","$filter","$timeout","Modal","BenchmarkPrice","BenchmarkPriceSubmitModal",function(t,i,e,a,n,o,r,u){function s(){t.constantIsSet?c():t.$watch("constantIsSet",function(t){t&&c()})}function c(){r.getBusinessType().success(function(i){if(200===i.code&&i.data)for(var e=t.constant.businessType.length-1;e>=0;e--){var a=t.constant.businessType[e],n=i.data;n.indexOf(a.value)>-1&&(a.enabled=!0)}})}function d(){var i={isUnifyedCPS:!0,unit:{},quotationMaterialList:[],ratio:{ratioThird:0}};i.unit.cps=[{}];for(var e in t.constant.industryType)i.unit.cps.push({industryId:e,industryTypeName:t.constant.industryType[e].industryTypeName,parentId:t.constant.industryType[e].parentId});return i}function l(){var i=d();t.quotationList=[i],1===t.editSiteArea.length&&t.setPriceSite(t.quotationList[0])}function f(){t.editSiteAreaFull=!1;for(var i=0,e=t.editSiteArea.length-1;e>=0;e--){t.editSiteArea[e].selected=!1;for(var a=t.quotationList.length-1;a>=0;a--)t.quotationList[a].site&&t.quotationList[a].site.value===t.editSiteArea[e].value&&(t.editSiteArea[e].selected=!0,i++)}i===t.editSiteArea.length&&(t.editSiteAreaFull=!0)}function q(){var i={},e="yyyy-MM-dd";i.quotationMain={};for(var n in t.quotationMain)i.quotationMain[n]=t.quotationMain[n];i.quotationMain.startTime=a("date")(t.quotationMain.startTime,e),i.quotationMain.endTime=a("date")(t.quotationMain.endTime,e),i.quotationList=[];for(var o=t.quotationList.length,r=0;o>r;r++){i.quotationList[r]={},i.quotationList[r].siteId=t.quotationList[r].site.value,i.quotationList[r].quotationMaterialList=t.quotationList[r].quotationMaterialList;for(var u in t.quotationList[r][t.quotationMain.priceType])i.quotationList[r][u]=t.quotationList[r][t.quotationMain.priceType][u];"unit"===t.quotationMain.priceType&&(i.quotationList[r].cps=[],t.quotationList[r].isUnifyedCPS?i.quotationList[r].cps.push(t.quotationList[r].unit.cps[0]):i.quotationList[r].cps=t.quotationList[r].unit.cps.slice(1))}return i}function v(){var i=t.check.platform(),e=t.check.effectiveTime(),a=!0;t.onCheck=!0;for(var n=t.quotationList.length-1;n>=0;n--)t.quotationList[n].checkPrice=!0,t.check.onePrice(t.quotationList[n])||(a=!1);return i&&a&&e}function m(e){r.save(e).success(function(e){if(200===e.code){var n=e.data.length,r=e.data.join("、"),u=a("translate")("QUOTATION_SAVE_SUCCESS_TEXT",{count:n})+r;t.msgs.listAlerts.push({type:"info",msg:u}),o.success({content:a("translate")("QUOTATION_SUBMIT_SUCCESS"),timeOut:3e3},function(){i.go("benchmarkPriceManagement.list")}),t.quotationSubmitDisable=!1}})}var p=new RegExp(/^[0-9]+([.]\d{1,2})?$/),h=new RegExp(/^([1-9]\d?(\.\d[1-9]0*|\.[1-9]0*)?|0\.(\d{1,2})0*|0|100(\.0+)?)$/);ratioPartternNoZero=new RegExp(/^([1-9]\d?(\.\d[1-9]0*|\.[1-9]0*)?|0\.([1-9]\d?|0[1-9])0*|100(\.0+)?)$/),s(),t.testPrice=function(){return{test:function(t){return p.test(t)&&t>0}}}(),t.editSiteArea=[],t.minDate=new Date,t.uploadOpts={uploadedText:a("translate")("ADD"),formatErrorText:"UPLOAD_FILE_TYPE_FORBIDDEN"},t.setPriceSite=function(i,e){if(e)i.site=e;else for(var a=t.editSiteArea.length,o=0;a>o;o++)if(!t.editSiteArea[o].selected){i.site=t.editSiteArea[o];break}t.check.onePrice(i),n(function(){f(t.editSiteArea)},100)},t.$watch("quotationMain.businessType",function(i,e){if(e&&t.quotationMain.priceType&&(t.checkPlatform=!0),i&&i!==e){for(var a=t.constant.platform,n=a.length,o=-1,r=0;n>r;r++)a[r].businessType===i&&(t.quotationMain.advertisingPlatformId=a[r].value,o++);o&&(t.quotationMain.advertisingPlatformId=null),t.editSiteArea=[],t.isEdit||l()}}),t.$watch("quotationMain.advertisingPlatformId",function(i,e){t.getSiteArea(i).then(function(a){if(t.editSiteArea=a,i!==e&&(t.isEdit||(t.quotationList=[]),0===t.quotationList.length&&t.editSiteArea&&l()),t.isEdit)for(var n=t.editSiteArea.length-1;n>=0;n--)if(t.editSiteArea[n].value===t.quotationList[0].siteId){t.quotationList[0].site=t.editSiteArea[n];break}f()})}),t.setRatio=function(t,i){t.ratio&&h.test(t.ratio[i])&&("ratioMine"===i?(t.ratio.ratioThird=0,t.ratio.ratioCustomer=Math.round(1e4-100*t.ratio.ratioMine)/100):"ratioCustomer"===i&&(t.ratio.ratioThird=Math.round(1e4-100*t.ratio.ratioMine-100*t.ratio.ratioCustomer)/100,t.ratio.ratioThird<0&&(t.ratio.ratioThird=0)))},t.addPrice=function(){if(t.quotationList.length<t.editSiteArea.length){var i=d();t.quotationList.splice(0,0,i),t.setPriceSite(t.quotationList[0])}},t.removePrice=function(i){t.quotationList.splice(i,1),f()},t.removeMaterial=function(i,e){i.quotationMaterialList.splice(e,1),t.check.onePrice(i)},t.submitPrice=function(){t.quotationSubmitDisable=!0;var i=function(){m(a)},e=function(){t.quotationSubmitDisable=!1};if(v()){var a=q();u.check(a,{},i,e)}else t.quotationSubmitDisable=!1},t.check={platform:function(){return t.checkPlatform=!0,!!t.quotationMain.advertisingPlatformId},effectiveTime:function(){return t.checkEffectiveTime=!0,!(!t.quotationMain.startTime||!t.quotationMain.endTime||t.quotationMain.startTime>t.quotationMain.endTime)},onePrice:function(i){var e=t.quotationMain.priceType,a={unit:function(){var t=[];for(var e in i.unit){var a=!1;if("cps"===e){a=!0;var n=!1,o=0,r=0;i.isUnifyedCPS||(o=1,r=i.unit[e].length-1);for(var u=o;r>=u;u++)i.unit[e][u].value&&!ratioPartternNoZero.test(i.unit[e][u].value)&&(a=!1),"undefined"!=typeof i.unit[e][u].value&&""!==i.unit[e][u].value&&(n=!0);n&&t.push(a)}else a=!(!i.unit[e].value||!p.test(i.unit[e].value)),"undefined"!=typeof i.unit[e].value&&""!==i.unit[e].value&&t.push(a)}for(var s=!!t.length,c=t.length-1;c>=0;c--)if(!t[c]){s=!1;break}return i.priceIsGood=s,s},ratio:function(){var t=!0,e=i.ratio;e||(t=!1),e.ratioMine&&ratioPartternNoZero.test(e.ratioMine)?(e.ratioCustomer&&!h.test(e.ratioMine)&&(t=!1),e.ratioThird&&!h.test(e.ratioMine)&&(t=!1)):t=!1;var a=Number(e.ratioMine)+(Number(e.ratioCustomer)||0)+(Number(e.ratioThird)||0);return 100!=a&&(t=!1),i.priceIsGood=t,t},rebate:function(){var t=!(!i.rebate||!i.rebate.ratioRebate&&!i.rebate.ratioRebate||!ratioPartternNoZero.test(i.rebate.ratioRebate));return i.priceIsGood=!!t,t},material:function(){return!!i.quotationMaterialList.length},site:function(){return!(!i.site||!i.site.value)}};return i.onCheck=!0,a.site()&&a.material()&&a[e]()}}}])});