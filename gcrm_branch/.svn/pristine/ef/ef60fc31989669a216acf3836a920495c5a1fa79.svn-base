define(["app","../../_common/ytCommon","../../_filters/CustomerFilter","../../_directives/ytInputDropdown","../../_directives/ytInputCheckboxes","../../_directives/ytInputRadio","../../_directives/ytJqueryFileUpload","../../_directives/ytAjaxupload","../../record/CustomerApprovalRecord","../../record/CustomerModifyRecord","../../_directives/checklistModel","../../_directives/ytPopoverConfirm"],function(t){t.registerController("CtrlCustomerDetail",["$scope","$state","$filter","$stateParams","$timeout","Modal","Customer","$window","CustomerApprovalRecord","CustomerModifyRecord","PageSet",function(t,e,a,o,n,s,c,i,u,r,d){d.set({siteName:"customerDetail",activeIndex:0});var p=a("translate");o.customerId?(t.basic={state:"detailViewing"},t.contact={state:"detailViewing"},t.opportunity={state:"detailViewing"},t.qualification={state:"detailViewing"},t.attachment={state:"detailViewing"},c.getDetail({id:o.customerId}).success(function(e){200===e.code&&(t.isOwner=e.data.isOwner,t.customerApplyInfo=e.data.customerApplyInfo,t.customerApplyInfo.companyStatus=e.data.customer.companyStatus,t.typeChangeNotAllowed=!e.data.typeChangeAllowed,t.basic=angular.extend(t.basic,e.data.customer),t.basic.industry=e.data.industry,e.data.agentCompany&&(t.basic.agentCompany={id:e.data.agentCompany.id,name:e.data.agentCompany.companyName,companyStatus:e.data.agentCompany.companyStatus}),t.basic.country=e.data.country,t.basic.currencyType=e.data.currencyType,e.data.belongSales&&(t.basic.belongSales={id:e.data.belongSales.ucid,name:e.data.belongSales.realname}),e.data.belongManager&&(t.basic.belongManager={name:e.data.belongManager.realname,id:e.data.belongManager.ucid}),t.basic.agentType=e.data.agentType,e.data.agentRegional&&(t.basic.agentRegionalShow={i18nName:e.data.agentRegional.i18nName},t.basic.agentRegional=e.data.agentRegional&&e.data.agentRegional.id,t.basic.agentCountries=e.data.agentRegional.agentCountries),t.basic.agentCountrySelected=e.data.agentCountry,t.basic.businessTypesSelected=e.data.customer.businessType.split(","),t.basic.maxDate=new Date,t.contact.contacts=e.data.contacts&&e.data.contacts.length?e.data.contacts:[{isEditing:!0}],e.data.opportunityView&&(t.opportunity=angular.extend(t.opportunity,e.data.opportunityView),t.opportunity.currencyTypes=e.data.currencyTypes,e.data.opportunityView.billingModel&&(t.opportunity.billingModelsSelected=e.data.opportunityView.billingModel.split(",")),e.data.opportunityView.businessType&&(t.opportunity.businessTypesSelected=e.data.opportunityView.businessType.split(",")),t.opportunity.platformsSelected=e.data.opportunityView.advertisingPlatforms),e.data.qualification&&(t.qualification=angular.extend(t.qualification,e.data.qualification)),t.attachment.attachments=e.data.attachments,c.getEditInfo().success(function(e){200===e.code&&(l.setEditData(e.data),"approved"===t.customerApplyInfo.approveState&&("offline"===t.basic.customerType?t.basic.customerTypes=["offline"]:t.basic.customerTypes.splice(t.basic.customerTypes.indexOf("offline"),1)))}))})):e.go("error.four");var l={setEditData:function(e){t.basic.customerTypes=e.customerTypes,t.basic.industryTypes=e.industrys,t.basic.companySizeTypes=e.companySizes,t.basic.currencyTypes=e.currencyTypes,t.basic.businessTypes=e.businessType,t.basic.agentTypes=e.agentTypes,t.basic.agentRegionals=e.agentRegionals,t.opportunity.currencyTypes=e.currencyTypes,t.opportunity.businessTypes=e.businessType,t.attachment.attachmentTypes=e.attachmentTypes},getAllPostParams:function(){var e={},a=c.resolveBasicData(t.basic),o=c.resolveContactData(t.contact.contacts),n=angular.copy(t.attachment.attachments);return e={customer:a,contacts:o,attachments:n},"offline"===t.basic.customerType?e.qualification=angular.copy(t.qualification):e.opportunity=c.resolveOpportunityData(t.opportunity),e}};t.$on("basicSave",function(){c.saveBasic(c.resolveBasicData(t.basic)).success(function(t){200===t.code&&s.success({content:p("SUCCESS_SAVE")},function(){i.location.reload()})})}),t.$on("opportunitySave",function(){var e=c.resolveOpportunityData(t.opportunity);e.customerNumber=t.customerApplyInfo.customerId,c.updateCustomerOpportunity(e).success(function(e){200===e.code&&s.success({content:p("SUCCESS_SAVE")},function(){t.opportunity.state="detailViewing"})})}),t.$on("qualificationSave",function(){t.qualification.customerNumber=t.customerApplyInfo.customerId,c.updateCustomerQualification(t.qualification).success(function(e){200===e.code&&s.success({content:p("SUCCESS_SAVE")},function(){t.qualification.state="detailViewing"})})}),t.saveToApproval=function(){t.disableToApproval=!0,c.saveToApprove(l.getAllPostParams()).success(function(a){t.disableToApproval=!1,200===a.code&&(t.basic.isValidating=!1,s.success({content:p("SUCCESS_SUBMIT_TO_APPROAVAL")},function(){o.customerId?i.location.reload():e.go("customer.detail.facade",{customerId:a.data.customer.id})}))})},t.sendReminder=function(t){c.sendReminder({customerId:t}).success(function(t){200===t.code&&s.success({content:p("SUCCESS_REMIDER"),timeOut:2e3})})},t.withdraw=function(t){c.withdraw({customerId:t}).success(function(t){200===t.code&&s.success({content:p("SUCCESS_WITHDRAW"),timeOut:2e3},function(){i.location.reload()})})},t.nullify=function(t){c.nullify({customerId:t}).success(function(t){200===t.code&&s.success({content:p("SUCCESS_NULLITY"),timeOut:2e3},function(){e.go("customer.list")})})},t.recover=function(t){c.recover({customer:{id:t}}).success(function(t){200===t.code&&s.success({content:p("SUCCESS_RECOVERY"),timeOut:2e3},function(){i.location.reload()})})},t.navToAd=function(t){t&&e.go("ad.facade",{customerNumber:t})},t.modalApprovalRecord=function(){u.show(o.customerId,{windowClass:"customer-approval-record"})},t.modalModifyRecord=function(){r.show(o.customerId,{windowClass:"customer-modify-record"})},t.queryContractList=function(){c.queryContractList({customerId:o.customerId}).success(function(e){200===e.code&&(t.contractList={list:e.data})})},t.queryAccountList=function(){t.$broadcast("queryAccountList")},t.closeTaskInfo=function(){t.customerApplyInfo.taskInfo=""}}])});