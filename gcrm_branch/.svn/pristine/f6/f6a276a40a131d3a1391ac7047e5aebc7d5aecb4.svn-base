define(["app","../../_common/ytCommon","../../_filters/AdSolutionTypeFilter","../../_filters/AdSolutionStatusFilter","../../_filters/AdContentCancelReasonFilter","anuglar-ui-select2","../../_services/Select2Suggest","../../_directives/ytCalendar","../../record/SolutionApprovalRecord","../../_directives/ytJqueryFileUpload","../../_directives/ytAjaxupload","../../_directives/periodLabel","./CtrlModalPO","../../_filters/PortionFilter","../../_filters/IndustryTypeFilter"],function(e){e.registerController("CtrlAdSolutionDetail",["$scope","PageSet","AdProgram","$stateParams","$state","Select2Suggest","Ad","$q","Position","$timeout","Modal","GCRMUtil","$filter","SolutionApprovalRecord","$modal","$window","AdSolutionDetailConstant","PublishPrice","$log","Industry","Utils","STATIC_DIR",function(e,t,n,o,i,a,r,s,d,c,l,u,f,p,C,S,v,g,m,I,D,h){function A(t){try{t=t||e.e.advertiseQuotation.billingModelId,4===t?e.e.advertiseQuotation.totalAmount=(e.e.insertDatesTotal-(e.e.insertDates.length-e.e.selectedInsertDays)||0)*(e.e.advertiseQuotation.dailyAmount||0):5===t?e.e.advertiseQuotation.totalPrice=((e.e.advertiseQuotation.customerQuote||0)*(e.e.insertDatesTotal-(e.e.insertDates.length-e.e.selectedInsertDays)||0)).toFixed(2):1===t&&(e.e.advertiseQuotation.totalPrice=((e.e.advertiseQuotation.customerQuote||0)*(e.e.insertDatesTotal-(e.e.insertDates.length-e.e.selectedInsertDays)||0)*e.e.position.click).toFixed(2))}catch(n){}}function T(t){var n=C.open({templateUrl:h+"app/adSolution/detail/POModal.tpl.html",controller:"CtrlModalPO",resolve:{opts:function(){return{type:t,customerNumber:e.v.customerI18nView.customer.customerNumber,adSolutionId:o.id}}}});n.result.then(function(e){e&&e.type&&("direct"===e.type?e.data?l.success({content:v.POSuccess},function(){S.location.reload()}):_():e.data?S.location.reload():_())})}function _(){r.createSingleContract({id:o.id}).success(function(e){200===e.code&&e.data&&l.success({content:v.btnContractTypeSuccess},function(){S.location.reload()})})}if(!o.id)return i.go("error.four"),!1;t.set({siteName:"adSolutionDetail",activeIndex:1}),n.getDetail({id:o.id}).success(function(t){if(200===t.code){if(e.v=t.data,e.v.adSolution.approvalStatus){var n,a,r,s=t.data.adSolution.approvalStatus;if("saving"===s){for(n=!0,a=t.data.approvalContentViews,r=0;r<a.length;r++)"saving"!==a[r].adSolutionContent.approvalStatus&&"refused"!==a[r].adSolutionContent.approvalStatus&&(n=!1);!n||t.data.cancelRecord&&t.data.cancelRecord.length||i.go("ad.facade",{programId:o.id})}else if("refused"===s){for(n=!0,a=t.data.approvalContentViews,r=0;r<a.length;r++)"refused"!==a[r].adSolutionContent.approvalStatus&&(n=!1);!n||t.data.cancelRecord&&t.data.cancelRecord.length||i.go("ad.facade",{programId:o.id})}"saving"!==s||e.v.approvalContentViews.length||e.v.cancelRecord.length||i.go("ad.facade",{programId:o.id}),("approving"===e.v.adSolution.approvalStatus||"confirmed"===e.v.adSolution.approvalStatus&&e.v.adSolution.contractType&&"Revoked"!==e.v.adSolution.contractStatus&&!e.v.contract)&&e.v.adSolution.taskInfo&&(e.alerts=[{type:"info",msg:e.v.adSolution.taskInfo}])}e.contractTypes="offline"===e.v.customerI18nView.customer.customerType?[{name:v.singleContract,type:"single"},{name:v.protocol,type:"protocol"}]:[{name:v.singleContract,type:"single"},{name:v.frame,type:"frame"}],"direct"===t.data.customerI18nView.customer.customerType&&(e.stateCustomerStraight={data:t.data.customerI18nView.customer.customerNumber,value:t.data.customerI18nView.customer.companyName})}}),e.optionCustomer=a.getCustomerOptionForAdOwner(),e.closeAlert=function(t){"info"===e.alerts[t].type&&e.alerts.splice(t,1)};var P={findArea:function(e,t){return this.find(e,t)},findPostion:function(e,t){return this.find(e,t)},find:function(e,t){var n;return angular.forEach(t,function(t){n||t.id!==e||(n=t)}),n},getDatePeriods:function(e){if(!e)return null;for(var t=[],n=[],o=e.split(";"),i=0;i<o.length;i++)t=o[i].split(","),t.length>1?n.push({from:t[0],to:t[1]}):o[i]&&n.push({from:o[i],to:o[i]});return n},getInsertDates:function(e){if(!e)return[];for(var t=[],n=e.split(";"),o=0;o<n.length;o++)t.push({date:n[o],checked:!0});return t},getSiteList:function(t){d.getSiteList({productId:t}).success(function(t){200===t.code&&(e.e.siteList=t.data,e.e.adSolutionContent.siteId=null,e.e.adSolutionContent.channelId=null,e.e.area=null,e.e.position=null)})},getChannelList:function(t,n){d.getChannelList({productId:t,siteId:n}).success(function(t){200===t.code&&(e.e.channelVOList=t.data,e.e.adSolutionContent.channelId=null,e.e.area=null,e.e.position=null)})},getAreaList:function(t){d.getAreaList({parentId:t}).success(function(t){200===t.code&&(e.e.areaVOList=t.data)})},getPositionList:function(t){d.getPositionList({parentId:t}).success(function(t){200===t.code&&(e.e.positionVOList=t.data)})},resolvePeriods:function(e){for(var t=e.length-1;t>=0;t--)if(e[t].from&&e[t].to){if(angular.isDate(e[t].from)?e[t].from=e[t].from.getTime():/\d/.test(e[t].from)||(e[t].from=new Date(e[t].from.replace(/-/g,"/")).getTime()),angular.isDate(e[t].to)?e[t].to=e[t].to.getTime():/\d/.test(e[t].to)||(e[t].to=new Date(e[t].to.replace(/-/g,"/")).getTime()),e[t].to<e[t].from){var n=e[t].to;e[t].to=e[t].from,e[t].from=n}}else e.splice(t,1);return e},queryInsertDates:function(t){if(!e.e.position.id||!e.e.datePeriods)return!1;var n=this.resolvePeriods(e.e.datePeriods),o={positionId:e.e.position.id,periods:n,insertDate:t};"confirmed"===e.e.adSolutionContent.approvalStatus?angular.extend(o,{oldContentId:e.e.adSolutionContent.id}):"update"===e.e.adSolutionContent.contentType&&angular.extend(o,{oldContentId:e.e.adSolutionContent.oldContentId}),r.queryInsertDates(o).success(function(t){if(200===t.code){e.e.datePeriods=t.data.datePeriod,e.e.datePeriods&&e.e.datePeriods.length||(e.e.datePeriods=[{}]),e.e.insertDates=t.data.insertDate,e.e.insertDatesTotal=t.data.totalDays,e.e.selectedInsertDays=e.e.insertDates&&e.e.insertDates.length;for(var n=0;n<e.e.insertDates.length;n++)e.e.insertDates[n].checked||(e.e.selectedInsertDays=e.e.selectedInsertDays-1);e.updateCPMTotalAmount()}})},clearPrice:function(){e.e.advertiseQuotation.ratioMine=0,e.e.advertiseQuotation.ratioCustomer=0,e.e.advertiseQuotation.ratioThird=0,e.e.advertiseQuotation.reachEstimate=!1,e.e.advertiseQuotation.ratioConditionDesc="",e.e.advertiseQuotation.publishPrice=null,e.e.advertiseQuotation.customerQuote=null,e.e.advertiseQuotation.discount=null,e.e.advertiseQuotation.budget=null,e.e.advertiseQuotation.totalPrice=null,e.e.advertiseQuotation.dailyAmount=null,e.e.advertiseQuotation.totalAmount=null,e.e.cpsProductRatioMine=null,this.toggleValidator(!1)},resetPrice:function(){this.clearPrice(),e.e.priceDisabled=!0,e.e.advertiseQuotation.priceType=null,e.e.position=null},getAdIndex:function(t){for(var n=0;n<e.v.approvalContentViews.length;n++)if(e.v.approvalContentViews[n]&&e.v.approvalContentViews[n].adSolutionContent.id===~~t)return n;return-1},resolveErrorArgsForAdContent:function(e){for(var t=0;t<e.length;t++)e[t]=e[t]?f("translate")("AD_CONTENT_TITLE")+(this.getAdIndex(e[t])+1):f("translate")("AD_CONTENT_CURRENT");return e},updateApprovalStatus:function(){for(var t=!0,n=0;n<e.v.approvalContentViews.length&&t;n++)"confirmed"!==e.v.approvalContentViews[n].adSolutionContent.approvalStatus&&(t=!1);t&&(e.v.adSolution.approvalStatus="confirmed")},queryQuotionPattern:function(){var t={advertisingPlatformId:e.e.adSolutionContent.productId,siteId:e.e.adSolutionContent.siteId,billingModelId:e.e.advertiseQuotation.billingModelId};t.billingModelId||delete t.billingModelId,g.post(t).success(function(t){200===t.code&&t.data.result&&(t.data.result[0]?2===~~e.e.advertiseQuotation.billingModelId?(e.e.productQuotes=t.data.result,(e.e.industrySelected||0===e.e.industrySelected)&&e.selectIndusty()):(e.e.advertiseQuotation.publishPrice=t.data.result[0].publishPrice,e.e.advertiseQuotation.productRatioMine=t.data.result[0].ratioMine,e.e.advertiseQuotation.productRatioCustomer=t.data.result[0].ratioCustomer||0,e.e.advertiseQuotation.productRatioThird=t.data.result[0].ratioThird||0):e.e.advertiseQuotation.discount=1)})},toggleValidator:function(t){e.e.contentSave=t,e.e.hiddenElValidator=t,e.e.positionChangeValidator=t,e.e.quotesValidator=t,e.e.materialValidator=t,e.e.codeContentValidator=t}};e.updateCPMTotalAmount=function(){A(4)},e.updateCustomerQuote=function(){e.e.advertiseQuotation.publishPrice&&(e.e.advertiseQuotation.customerQuote=(e.e.advertiseQuotation.discount*e.e.advertiseQuotation.publishPrice).toFixed(2)),A()},e.updateDiscount=function(){e.e.advertiseQuotation.publishPrice&&(e.e.advertiseQuotation.discount=(e.e.advertiseQuotation.customerQuote/e.e.advertiseQuotation.publishPrice).toFixed(2)),A()},e.selectIndusty=function(){if(!e.e.productQuotes||!e.e.productQuotes.length)return e.e.cpsProductRatioMine=void 0,!1;for(var t=0;t<e.e.productQuotes.length;t++){if(void 0===e.e.productQuotes[t].industryId){e.e.cpsProductRatioMine=e.e.productQuotes[t].ratioMine;break}if(e.e.productQuotes[t].industryId===~~e.e.industrySelected){e.e.cpsProductRatioMine=e.e.productQuotes[t].ratioMine;break}e.e.cpsProductRatioMine=void 0}},e.btnEdit=function(t,n){e.currentContent=t,e.isEditing=!0,t.editing=!0,s.all([r.getBillingModel(),r.getContentInfo({id:t.adSolutionContent.id}),I.getIndustryTypes()]).then(function(t){if(!(t[0]&&t[1]&&t[0].data&&t[1]))return!1;var o=t[0].data,i=t[1].data,a=t[2].data;200===o.code&&200===i.code&&(e.e=i.data,e.e.industryTypes=a.data,c(function(){e.e.industrySelected=i.data.advertiseQuotation.industryType,e.selectIndusty()},200),("unconfirmed"===e.e.adSolutionContent.approvalStatus||"confirmed"===e.e.adSolutionContent.approvalStatus)&&(e.e.showAlert=!0),(n||"update"===e.e.adSolutionContent.contentType)&&(e.e.calendarFutureOnly=!0),e.e.advertiser={value:e.e.adSolutionContent.advertiser,data:e.e.adSolutionContent.advertiserId},e.stateCustomerStraight&&(e.e.advertiser=e.stateCustomerStraight),e.e.area=P.findArea(e.e.adSolutionContent.areaId,e.e.areaVOList),e.e.position=P.findPostion(e.e.adSolutionContent.positionId,e.e.positionVOList),e.e.priceTypes=[{label:"AD_CONTENT_UNIT_PRICE",value:"unit"},{label:"AD_CONTENT_FALL_INTO",value:"ratio"}],e.e.isEstimated=[{label:"YES",value:!0},{label:"NO",value:!1}],e.e.billingModels=o.data.result,e.e.datePeriods=P.getDatePeriods(e.e.adSolutionContent.periodDescription),e.e.insertDatesTotal=e.e.adSolutionContent.totalDays,e.e.insertDates=P.getInsertDates(e.e.adSolutionContent.insertPeriodDescription),e.e.selectedInsertDates=e.e.insertDates,e.e.selectedInsertDays=e.e.insertDates.length,e.e.insertDatesCheckAll=!0,P.queryQuotionPattern())})},e.changeProduct=function(e){P.resetPrice(),e&&P.getSiteList(e)},e.changeSite=function(e,t){P.resetPrice(),e&&t&&P.getChannelList(e,t)},e.changeChannel=function(e){P.resetPrice(),e&&P.getAreaList(e)},e.changeArea=function(e){P.resetPrice(),e&&P.getPositionList(e)},e.changePosition=function(){e.e.position?e.e.priceDisabled=!1:(e.e.advertiseQuotation.priceType=null,P.clearPrice(),e.e.priceDisabled=!0),e.e.advertiseQuotation.billingModelId=-1,e.e.datePeriods=[{}],e.e.insertDates=null,e.e.insertDatesTotal=0,e.e.selectedInsertDays=0,e.e.adSolutionContent.materialEmbedCode=0,e.e.adSolutionContent.materialTitle=null,e.e.adSolutionContent.materialUrl=null,e.e.advertiseMaterials=null},e.changePriceType=function(){e.e.advertiseQuotation.billingModelId=0,e.e.industrySelected=void 0,P.clearPrice(),P.queryQuotionPattern()},e.changeBillingModel=function(){e.e.industrySelected=void 0,P.clearPrice(),P.queryQuotionPattern()},e.startTimeChange=function(t){t.to&&t.from&&P.queryInsertDates(e.e.insertDates)},e.endTimeChange=function(t){t.to&&t.from&&P.queryInsertDates(e.e.insertDates)},e.removePeriod=function(t){if(e.e.calendarFutureOnly)if("number"==typeof e.e.datePeriods[t].from){if(e.e.datePeriods[t].from<D.getTodayZero().getTime())return!1}else if("string"==typeof e.e.datePeriods[t].from&&new Date(e.e.datePeriods[t].from.replace(/-/g,"/")).getTime()<D.getTodayZero().getTime())return!1;e.e.datePeriods.splice(t,1),P.queryInsertDates(e.e.insertDates)},e.addPeriod=function(){e.e.datePeriods.push({})},e.toggleCheckAll=function(){if(e.e.insertDates){var t;if(e.e.insertDatesCheckAll){for(t=0;t<e.e.insertDates.length;t++)e.e.insertDates[t].checked=!0;e.e.selectedInsertDays=e.e.insertDates.length}else{for(t=0;t<e.e.insertDates.length;t++)e.e.insertDates[t].checked=!1;e.e.selectedInsertDays=0}e.updateCPMTotalAmount()}},e.toggleCheck=function(t){t.checked=!t.checked;var n=!!e.e.insertDates.length,o=0;angular.forEach(e.e.insertDates,function(e){e.checked?o++:n=!1}),e.e.selectedInsertDays=o,e.e.insertDatesCheckAll=n,e.updateCPMTotalAmount()},e.adContentApproval=function(t,n,o,i){if(t.$valid){e.e.contentSave=!1,e.e.hiddenElValidator=!1,e.e.positionChangeValidator=!1,e.e.quotesValidator=!1;var a=e.e;a.adSolutionContent.advertiser=e.e.advertiser.value,e.e.advertiser.data&&(a.adSolutionContent.advertiserId=e.e.advertiser.data),a.adSolutionContent.areaId=e.e.area.id,a.adSolutionContent.positionId=e.e.position.id,a.adSolutionContent.materialType=e.e.position.materialType,a.periods=e.e.datePeriods,"undefined"!=typeof e.e.industrySelected&&(a.advertiseQuotation.industryType=e.e.industrySelected);for(var s=[],d=0;d<e.e.insertDates.length;d++)e.e.insertDates[d].checked&&s.push(e.e.insertDates[d]);a.insertDate=s,2===~~e.e.advertiseQuotation.billingModelId&&(a.advertiseQuotation.productRatioMine=e.e.cpsProductRatioMine),a.approvalType=i?"change":"modify",r.contentApproval(a,function(e){if(200===e.code)S.location.reload();else if(204===e.code){for(var t=[],n=0;n<e.errorList.length;n++)t.push(u.translate(e.errorList[n].key,P.resolveErrorArgsForAdContent(e.errorList[n].args)));l.alert({contentList:t})}})}else e.e.contentSave=!0,e.e.hiddenElValidator=!0,e.e.positionChangeValidator=!0,e.e.quotesValidator=!0,e.e.materialValidator=!0,e.e.codeContentValidator=!0,e.anchorTo("anchorContent"+o)},e.adContentCancel=function(t){t.editing=!1,e.isEditing=!1},e.btnSubmitAdSolution=function(){n.submit({id:o.id},function(e){if(200===e.code)l.alert({content:f("translate")("AD_BASIC_ALERT_SUBMIT_SUCCESS")},function(){});else if(204===e.code){for(var t=[],n=0;n<e.errorList.length;n++)t.push(u.translate(e.errorList[n].key,P.resolveErrorArgsForAdContent(e.errorList[n].args)));l.alert({contentList:t})}})},e.btnApprovalRecord=function(e){p.forContent(e.adSolutionContent.id,{windowClass:"approval-record-modal"})},e.btnTerminate=function(e){l.confirm({content:v.terminateWarn,psInfo:v.terminatePS},function(){r.contentTerminate({id:e.adSolutionContent.id}).success(function(e){200===e.code&&S.location.reload()})})},e.btnConfirmContent=function(e){function t(){r.confirmContentSchedule({id:e.adSolutionContent.id,overdue:e.overdue}).success(function(e){200===e.code&&S.location.reload()})}e.schedule.number;e.overdue?l.confirm({content:v.confirmWarn,psInfo:v.confirmWarnPS},t):t()},e.btnReSchedule=function(e){l.confirm({content:v.rescheduleWarn},function(){r.reSchedule({id:e.adSolutionContent.id}).success(function(e){200===e.code&&l.success({content:v.rescheduleSuccess},function(){S.location.reload()})})})},e.$watch("e.materialUploaded",function(t){t&&(e.e.advertiseMaterials=e.e.advertiseMaterials||[],e.e.advertiseMaterials.push(t))}),e.removeMaterial=function(t){var n=e.e.advertiseMaterials;n[t].id&&r.deleMaterials({id:n[t].id},function(){}),e.e.advertiseMaterials.splice(t,1)},e.btnCancelAd=function(){l.confirm({content:v.warnAdCancel},function(){r.cancelAd({id:o.id}).success(function(t){200===t.code&&l.success({content:v.successAdCancel},function(){try{i.go("ad.facade",{programId:e.v.adSolution.id})}catch(t){i.go("ad.facade")}})})})},e.btnCancelContent=function(e){l.confirm({content:v.warnContentCancel},function(){r.cancelContent({id:e.adSolutionContent.id}).success(function(e){200===e.code&&l.success({content:v.successAdCancel},function(){S.location.reload()})})})},e.btnCreatePO=function(){r.findContactPO({id:o.id}).success(function(e){200===e.code&&(e.data?l.success({content:v.btnCreatePOSuccess},function(){S.location.reload()}):T("direct"))})},e.btnContractType=function(e,t){"single"===e?_():t?r.createSingleContract({id:o.id}).success(function(e){200===e.code&&l.success({content:v.btnContractTypeSuccess},function(){S.location.reload()})}):T(e)},e.btnViewCanceled=function(e){S.open("#/adContentDetail?id="+e.adSolutionContentId)},e.btnCancelSingle=function(){r.revokeContract({id:o.id}).success(function(e){200===e.code&&l.success({content:v.successSingleCancel},function(){S.location.reload()})})},e.btnAdSolutionChange=function(){r.changeAdSolution({id:o.id}).success(function(e){200===e.code&&i.go("ad.facade",{programId:e.data.adSolution.id})})},e.btnAdModify=function(){r.modifyAd({id:o.id}).success(function(e){200===e.code&&S.location.reload()})},e.btnChangePO=function(t){r.changePO({adcontentId:t.adSolutionContent.id,contractNumber:e.v.contract.number}).success(function(e){200===e.code&&l.success({content:v.successChangePO},function(){S.location.reload()})})}}]),e.registerService("AdSolutionDetailConstant",["$filter",function(e){var t=e("translate");return{terminateWarn:t("AD_SOLUTION_DETAIL_WARN_TERMINATE"),terminatePS:t("AD_SOLUTION_DETAIL_WARN_TERMINATE_PS"),confirmWarn:t("AD_SOLUTION_DETAIL_WARN_CONFIRM"),confirmWarnPS:t("AD_SOLUTION_DETAIL_WARN_CONFIRM_PS"),rescheduleWarn:t("AD_SOLUTION_DETAIL_WARN_RESCHEDULE"),frame:t("AD_SOLUTION_DETAIL_FRAME"),protocol:t("AD_SOLUTION_DETAIL_PROTOCOL"),btnContractTypeSuccess:t("AD_SOLUTION_DETAIL_SUCCESS_SUBMITTED_TO_BUSSINESS"),btnCreatePOSuccess:t("AD_SOLUTION_DETAIL_SUCCESS_CREATED_PO"),rescheduleSuccess:t("AD_SOLUTION_DETAIL_SUCCESS_RESCHEDULE_SEND"),singleContract:t("SINGLE_CONTRACT"),warnAdCancel:t("AD_SOLUTION_DETAIL_WARN_CANCEL_AD"),warnContentCancel:t("AD_SOLUTION_DETAIL_WARN_CANCEL_CONTENT"),successAdCancel:t("AD_SOLUTION_DETAIL_SUCCESS_CANCELED"),successSingleCancel:t("AD_SOLUTION_DETAIL_SUCCESS_CANCELED_SINGLE"),successAdChange:t("AD_SOLUTION_DETAIL_SUCCESS_AD_CHANGE"),POSuccess:t("AD_SOLUTION_DETAIL_PO_SUCCESS"),successChangePO:t("AD_SOLUTION_DETAIL_CHANGE_PO_SUCCESS")}}])});