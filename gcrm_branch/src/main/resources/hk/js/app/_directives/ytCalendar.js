define(["app","../_services/http/DateStatus","../_filters/CalendarTdTitleFilter"],function(t){t.registerFactory("ytCalendarMax",["DateStatus","$q",function(t,e){var n;return{getMax:function(a){var r=e.defer();return n?r.resolve(n):t.getMaxDate({id:a}).then(function(t){n=t.data,r.resolve(t.data)}),r.promise}}}]),t.registerDirective("ytCalendar",["$timeout","$parse","dateFilter","DateStatus","$position","$compile","$document","ytCalendarMax",function(t,e,n,a,r,o,i,l){return{require:"?^ngModel",restrict:"A",priority:1,link:function(u,g,c,d){function s(){var t=angular.element("<div yt-datepicker-popup-wrap></div>");t.attr({"ng-model":"date"});var e=o(t)(C);g.after(e)}function f(e){e.preventDefault(),e.stopPropagation(),t(function(){h(!0),C.isOpen||(C.$apply(function(){C.isOpen=!0}),g.attr("disabled","disabled"))},100)}function p(t){C.isOpen&&t.target!==g[0]&&(C.isOpen=!1,C.$$phase||C.$apply(),g.removeAttr("disabled"))}function h(t){t&&(T=new Date(d.$modelValue?d.$modelValue:S)),a.get({period:{from:n(D(),_),to:n(v(),_)},positionId:k},function(t){var e=[];200===t.code&&(e=t.data.occupations,C.isRotation=t.data.rotation,t.data.rotation&&(C.rotationTotal=t.data.totalCount)),C.labels="SUNDAY_SHORT,MONDAY_SHORT,TUESDAY_SHORT,WEDNESDAY_SHORT,THURSDAY_SHORT,FRIDAY_SHORT,SATURDAY_SHORT".split(",");for(var n=m(T),a=n.length-1;a>=0;a--){for(var r=e.length-1;r>=0;r--)"idle"===e[r].status?e.splice(r,1):n[a].date&&e[r].date==n[a].date.getTime()&&(n[a].status=e[r].status,n[a].biddingCount=e[r].biddingCount,C.rotationTotal&&(n[a].busyCount=e[r].busyCount),e.splice(r,1));(n[a].date>O||n[a].date<S)&&(n[a].disabled=!0)}var o=Y(n,7);if(7!==o[o.length-1].length)for(var i=o[o.length-1].length,l=i;7>l;l++)o[o.length-1].push({disabled:!0});C.rows=o,C.title=T.getFullYear()+"/"+(T.getMonth()+1)})}function D(){var t=T.getFullYear(),e=T.getMonth();return t===y.getFullYear()&&e===y.getMonth()?y:new Date(t,e,1)}function v(){var t=T.getFullYear(),e=T.getMonth();return t===O.getFullYear()&&e===O.getMonth()?O:new Date(new Date(t,e+1,1)-864e5)}function M(){C.position=r.position(g),C.position.top=C.position.top+g.prop("offsetHeight")}function m(t,e){for(var n=t.getFullYear(),a=t.getMonth(),r=new Date(n,a,1),o=r.getDay()%7,i=new Date(n,a+1,0).getDate(),l=$(r,i),u=0;i>u;u++){var g=new Date(l[u]);l[u]=w(g,"d",e&&e.getDate()===g.getDate()&&e.getMonth()===g.getMonth()&&e.getFullYear()===g.getFullYear(),g.getMonth()!==a)}for(var c=0;o>c;c++)l.unshift({disabled:!0});return l}function w(t,e){return{date:t,label:n(t,e)}}function Y(t,e){for(var n=[];t.length>0;)n.push(t.splice(0,e));return n}function $(t,e){for(var n=new Array(e),a=t,r=0;e>r;)n[r++]=new Date(a),a.setDate(a.getDate()+1);return n}function F(){var t=new Date(O),e=new Date(S),n=T;if(!t||!e||t.getTime()<e.getTime())return[];for(var a=[],r=new Date(e).setDate(1);r<=t.getTime();){var o=e.getMonth()+1;10>o&&(o="0"+o);var i={month:o,year:e.getFullYear()};b(e,n)&&(i.active=!0),a.push(i),e.setMonth(e.getMonth()+1),r=new Date(e).setDate(1)}return a}function b(t,e){return t.getMonth()===e.getMonth()&&t.getFullYear()===e.getFullYear()?!0:!1}var T,y=new Date;T=new Date(y.getFullYear(),y.getMonth(),y.getDate());var S=new Date(y.getFullYear(),y.getMonth(),y.getDate()),O=new Date(S.getFullYear()+1,S.getMonth(),S.getDate());c.$observe("trigger",function(t){t&&(k=t,l.getMax(k).then(function(t){O=new Date(t.data),s()}))}),c.min&&u.$watch(e(c.min),function(t){if(t){var e=new Date(t);S=new Date(e.getFullYear(),e.getMonth(),e.getDate())}}),u.$watch(e(c.futureOnly),function(t){t&&d.$modelValue&&!A(d.$modelValue,y)&&g.attr("disabled","disabled")});var k,A=function(t,e){return t&&e?(t=R(t),e=R(e),t.getTime()>=e.getTime()):void 0},R=function(t){return angular.isDate(t)?new Date(t.getFullYear(),t.getMonth(),t.getDate()):new Date(angular.isNumber(t)?t:t.replace(/-/g,"/"))},_="yyyy-MM-dd",C=u.$new();C.currentDate=T,C.isOpen=!1;var H=!1,P=!1;u.$watch("model",function(){d.$render()}),C.select=function(t){C.currentDate=t,p({}),C.date=t,d.$setViewValue(t),d.$render()},d.$render=function(){var t=d.$viewValue?n(d.$viewValue,_):"";g.val(t)},C.refresh=function(){h()},C.move=function(t){(-1!==t||T.getFullYear()!==y.getFullYear()||T.getMonth()!==y.getMonth())&&(1!==t||T.getFullYear()!==O.getFullYear()||T.getMonth()!==O.getMonth())&&(T.setDate(1),T.setMonth(T.getMonth()+t),h())},C.$watch("isOpen",function(t){t?(M(),i.bind("click",p),P&&g.unbind("focus",f),g[0].focus(),H=!0):(H&&i.unbind("click",p),g.bind("focus",f),P=!0)}),C.toggleMode=function(){C.modePickMonth=!C.modePickMonth,C.modePickMonth&&(C.availableMonths=F())},C.pickMonth=function(t){T.setMonth(t.month-1),T.setFullYear(t.year),h(),C.modePickMonth=!C.modePickMonth}}}}]),t.registerDirective("ytDatepickerPopupWrap",["STATIC_DIR",function(t){return{restrict:"EA",replace:!0,templateUrl:t+"app/_directives/calendar.tpl.html",link:function(t,e){e.bind("click",function(t){t.preventDefault(),t.stopPropagation()})}}}])});