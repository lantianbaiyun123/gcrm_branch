define(["app","jquery-fileupload","../_common/ytCommon"],function(e){e.registerDirective("ytJqueryFileUpload",["$parse","$log","Modal","APP_CONTEXT","$filter","$compile","Utils",function(e,n,a,t,o,l,i){return{scope:{ngModel:"=",uploadData:"=",uploadedCbfn:"&",sendBeginCbfn:"&"},link:function(n,p,d){var u=(e(d.ngModel),i.toBoolean(d.isPushIn)||!1),r=i.toBoolean(d.isSpliceTo)||!1,s=t+d.uploadUrl,f=d.uploadType||".*",c=d.uploadInvalidatetype||"",m=new RegExp("\\.("+f+")$"),g=new RegExp("\\.("+c+")$"),T=JSON.parse(d.ytJqueryFileUpload),y=T.beginUpload,A=T.uploadDone;if(!s)return!1;var h=o("translate")("AJAX_UPLOAD_UPLOADING"),x=o("translate")("AJAX_UPLOAD_TYPE_NOT_ALLOW"),N=o("translate")("AJAX_UPLOAD_UPLOAD"),U=o("translate")("AJAX_UPLOAD_TRY_AGAIN"),_=p;if("INPUT"!=p.nodeName){var b=d.uploadFileName||"materialFile";if(p.css("position","relative"),_=angular.element('<input type="file" name="'+b+'" style=" position:absolute; opacity: 0; -ms-filter: \'alpha(opacity=0)\'; height:100%; cursor:pointer; top:0; left:0; width:100%;" multiple="true"/>'),""!==p.html()){var L=l('<span class="upLoadText">'+p.text()+"</span>")(n);iconNode=p.children(".glyphicon"),p.html(""),iconNode&&p.append(iconNode).append(" "),p.append(L)}p.append(angular.element('<form action="'+s+'" method="post"></form>').append(_).append(angular.element('<input name="id" style="display:none;" type="text" value="'+d.uploadTriggersource+'">')))}"INPUT"!=p.nodeName?_.click(function(){$=!1}):p.click(function(){$=!1});var P=p,v=0,$=!1,C=function(e){(e||-1===e)&&_.fileupload({url:s,formData:{id:e},dataType:"json",add:function(e,n){n.files[0].name&&!g.test(n.files[0].name)&&m.test(n.files[0].name)?(P.find(".upLoadText").html(T.uploadingText||h),n.submit()):$||(a.alert({content:o("translate")(T.formatErrorText)||x}),$=!0)},send:function(){v?v++:v=1,n.$apply(function(){n[y]&&n[y](),n.sendBeginCbfn&&n.sendBeginCbfn()})},done:function(e,t){var l=t.result;v--,null!==l&&200==l.code?(0===v&&(P.find(".upLoadText").html(T.uploadedText||N),n.$apply(function(){n[A]&&n[A](),n.uploadedCbfn&&n.uploadedCbfn()})),n.$apply(function(){u?n.ngModel.push(l.data):r?n.ngModel.splice(0,0,l.data):n.ngModel=l.data})):(0===v&&(P.find(".upLoadText").html(T.uploadedText||U),n.$apply(function(){n[A]&&n[A](),n.uploadedCbfn&&n.uploadedCbfn()})),null!==l||$||(l={},l.message=o("translate")(T.formatErrorText)||x),a.alert({content:l.message||T.uploadFalseText||"上传失败，请重新上传"}))}})};d.uploadTriggersource?d.$observe("uploadTriggersource",function(e){C(e)}):C(-1)}}}])});