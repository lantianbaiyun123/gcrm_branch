define(["app","../_directives/ytCalendar","../_directives/periodLabel","../_directives/ytJqueryFileUpload","../_directives/ytAjaxupload","./ModalPubApply"],function(e){e.registerController("CtrlAdContent",["$scope","$window","AdHttp","AdContent","AdContentUtil","AdConstant","GCRMUtil","SolutionApprovalRecord","Modal","ModalPubApply",function(e,t,n,o,i,a,r,d,s,c){function u(){var t=e.e;t.adSolutionContent.adSolutionId||(t.adSolutionContent.adSolutionId=e.solutionId),t.adSolutionContent.advertiser=e.e.advertiser.value,e.e.advertiser.data&&(t.adSolutionContent.advertiserId=e.e.advertiser.data),t.adSolutionContent.areaId=e.e.area.id,t.adSolutionContent.positionId=e.e.position.id,t.adSolutionContent.materialType=e.e.position.materialType,t.periods=e.e.datePeriods,"undefined"!=typeof e.e.industrySelected&&(t.advertiseQuotation.industryType=e.e.industrySelected);for(var n=[],o=0;o<e.e.insertDates.length;o++)e.e.insertDates[o].checked&&n.push(e.e.insertDates[o]);return t.insertDate=n,2===~~e.e.advertiseQuotation.billingModelId&&(t.advertiseQuotation.productRatioMine=e.e.cpsProductRatioMine),t}o.init(e),e.btnApprovalRecord=function(e){d.forContent(e.adSolutionContent.id,{windowClass:"approval-record-modal"})},e.adContentAddCancel=function(t){e.adContents.splice(t,1),e.state.isGlobleEditing=!1},e.adContentEditCancel=function(t){t.review=!0,e.state.isGlobleEditing=!1},e.btnReSchedule=function(e){n.reSchedule({id:e.adSolutionContent.id}).success(function(e){200===e.code&&s.success({content:a.rescheduleSuccess},function(){t.location.reload()})})},e.btnConfirmContent=function(e){function n(e){o.confirmContentSchedule(e).success(function(e){200===e.code&&t.location.reload()})}e.schedule.number;e.overdue?s.confirm({content:a.confirmWarn,psInfo:a.confirmWarnPS},n(e)):n(e)},e.btnTerminate=function(e){s.confirm({content:a.terminateWarn,psInfo:a.terminatePS},function(){n.contentTerminate({id:e.adSolutionContent.id}).success(function(e){200===e.code&&t.location.reload()})})},e.btnChangePO=function(o){n.changePO({adcontentId:o.adSolutionContent.id,contractNumber:e.basic.contract.number}).success(function(e){200===e.code&&s.success({content:a.successChangePO},function(){t.location.reload()})})},e.btnCancelContent=function(e){n.cancelContent({id:e.adSolutionContent.id}).success(function(e){200===e.code&&s.success({content:a.successAdCancel},function(){t.location.reload()})})},e.adContentRemove=function(t,o){var i=o.solutionContentId||o.adSolutionContent.id;i&&n.contentRemove({id:i}).success(function(n){200===n.code&&(e.adContents.splice(t,1),e.anchorTo("anchorContent"+(t-1)))})},e.btnEditContent=function(t,n){o.edit(e,t,n)},e.adContentSave=function(a,d,c){if(a.$valid){e.e.contentSave=!1,e.e.hiddenElValidator=!1,e.e.positionChangeValidator=!1,e.e.quotesValidator=!1;var l=u();c?(l.approvalType=c,n.contentApproval(l).success(function(n){if(200===n.code)t.location.reload();else if(204===n.code){for(var o=[],a=0;a<n.errorList.length;a++)o.push(r.translate(n.errorList[a].key,i.resolveErrorArgsForAdContent(e,n.errorList[a].args)));s.alert({contentList:o})}})):n.save(l).success(function(t){if(200===t.code)angular.extend(e.ad,t.data),e.ad.canUpdate=!0,e.state.isGlobleEditing=!1,e.ad.review=!0,t.data.advertiseCodeMaterial||(e.ad.advertiseCodeMaterial={}),(t.data.emptyMaterial||!t.data.advertiseMaterials)&&(e.advertiseMaterials=[]),o.updateContentState(e),e.anchorTo("anchorContent"+d);else if(204===t.code){for(var n=[],a=0;a<t.errorList.length;a++)n.push(r.translate(t.errorList[a].key,i.resolveErrorArgsForAdContent(e,t.errorList[a].args)));s.alert({contentList:n})}})}else e.e.contentSave=!0,e.e.hiddenElValidator=!0,e.e.positionChangeValidator=!0,e.e.quotesValidator=!0,e.anchorTo("anchorContent"+d)},e.selectIndusty=function(){if(!e.e.productQuotes||!e.e.productQuotes.length)return e.e.cpsProductRatioMine=void 0,!1;for(var t=0;t<e.e.productQuotes.length;t++){if(void 0===e.e.productQuotes[t].industryId){e.e.cpsProductRatioMine=e.e.productQuotes[t].ratioMine;break}if(e.e.productQuotes[t].industryId===~~e.e.industrySelected){e.e.cpsProductRatioMine=e.e.productQuotes[t].ratioMine;break}e.e.cpsProductRatioMine=void 0}},e.popPubApply=function(t){function o(e){c.applyView(e).then(function(){})}var i={adSolutionId:e.ad.adSolutionContent.adSolutionId,adSolutionContentId:e.ad.adSolutionContent.id,adSolutiionContentNumber:e.ad.adSolutionContent.number,customerNumber:e.basic.customerI18nView.customer.customerNumber,attachments:[]};t?n.pubApplyInfo({applyId:e.ad.applyId}).success(function(e){if(200===e.code){var t=e.data,n=t.adSolutionContentApply;i.id=n.id,i.contractNumber=n.contractNumber,i.applyReason=n.applyReason,i.attachments=t.attachments,o(i)}}):o(i)},e.popPubApplyEdit=function(){},e.popPubApplyDetail=function(){n.pubApplyInfo({applyId:28}).success(function(e){if(200===e.code){var t=e.data;c.detailView({applyDetail:t}).then(function(){})}})}}]),e.registerController("CtrlAdContentGeneral",["$scope",function(){}]),e.registerController("CtrlAdContentPosition",["$scope","AdContentUtil",function(e,t){e.changeProduct=function(n){t.resetPrice(e),n&&t.getSiteList(e,n)},e.changeSite=function(n,o){t.resetPrice(e),n&&o&&t.getChannelList(e,n,o)},e.changeChannel=function(n){t.resetPrice(e),n&&t.getAreaList(e,n)},e.changeArea=function(n){t.resetPrice(e),n&&t.getPositionList(e,n)},e.changePosition=function(){e.e.position?e.e.priceDisabled=!1:(e.e.advertiseQuotation.priceType=null,t.clearPrice(scope),e.e.priceDisabled=!0),e.e.datePeriods=[{}],e.e.insertDates=null,e.e.insertDatesTotal=0,e.e.selectedInsertDays=0,e.e.adSolutionContent.materialEmbedCode=0,e.e.adSolutionContent.materialTitle=null,e.e.adSolutionContent.materialUrl=null,e.e.advertiseMaterials=[]}}]),e.registerController("CtrlAdContentAdvertising",["$scope","AdContentUtil",function(e,t){e.addPeriod=function(){e.e.datePeriods.push({})},e.startTimeChange=function(n){n.to&&n.from&&t.queryInsertDates(e)},e.endTimeChange=function(n){n.to&&n.from&&t.queryInsertDates(e)},e.removePeriod=function(n){if(e.e.calendarFutureOnly)if("number"==typeof e.e.datePeriods[n].from){if(e.e.datePeriods[n].from<Utils.getTodayZero().getTime())return!1}else if("string"==typeof e.e.datePeriods[n].from&&new Date(e.e.datePeriods[n].from.replace(/-/g,"/")).getTime()<Utils.getTodayZero().getTime())return!1;e.e.datePeriods.splice(n,1),t.queryInsertDates(e)},e.toggleCheckAll=function(){if(e.e.insertDates){var n;if(e.e.insertDatesCheckAll){for(n=0;n<e.e.insertDates.length;n++)e.e.insertDates[n].checked=!0;e.e.selectedInsertDays=e.e.insertDates.length}else{for(n=0;n<e.e.insertDates.length;n++)e.e.insertDates[n].checked=!1;e.e.selectedInsertDays=0}t.updateTotal(e)}},e.toggleCheck=function(n){n.checked=!n.checked;var o=!!e.e.insertDates.length,i=0;angular.forEach(e.e.insertDates,function(e){e.checked?i++:o=!1}),e.e.selectedInsertDays=i,e.e.insertDatesCheckAll=o,t.updateTotal(e)}}]),e.registerController("CtrlAdContentPricing",["$scope","AdContentUtil",function(e,t){e.updateCPMTotalAmount=function(){t.updateTotal(e)},e.changePriceType=function(){e.e.advertiseQuotation.billingModelId=0,e.e.industrySelected=void 0,t.clearPrice(e),t.queryQuotionPattern(e)},e.changeBillingModel=function(){e.e.industrySelected=void 0,t.clearPrice(e),t.queryQuotionPattern(e)},e.updateCustomerQuote=function(){e.e.advertiseQuotation.publishPrice&&(e.e.advertiseQuotation.customerQuote=(e.e.advertiseQuotation.discount*e.e.advertiseQuotation.publishPrice).toFixed(2)),t.updateTotal(e)},e.updateDiscount=function(){e.e.advertiseQuotation.publishPrice&&(e.e.advertiseQuotation.discount=(e.e.advertiseQuotation.customerQuote/e.e.advertiseQuotation.publishPrice).toFixed(2)),t.updateTotal(e)},e.setRatio=function(t){var n=new RegExp(/^([1-9]\d?(\.\d[1-9]0*|\.[1-9]0*)?|0\.(\d{1,2})0*|0|100(\.0+)?)$/),o=e.e.advertiseQuotation;o&&n.test(o[t])&&("ratioMine"===t?(o.ratioThird=0,o.ratioCustomer=Math.round(1e4-100*o.ratioMine)/100):"ratioCustomer"===t&&(o.ratioThird=Math.round(1e4-100*o.ratioMine-100*o.ratioCustomer)/100,o.ratioThird<0&&(o.ratioThird=0)))}}]),e.registerController("CtrlAdContentMaterial",["$scope","AdHttp","AdContentUtil",function(e,t){e.removeCodeUploaded=function(e){e.advertiseCodeMaterial=null},e.beginUpload=function(){e.contentState.isSaveBtnDisabled=!0},e.uploaded=function(){e.contentState.isSaveBtnDisabled=!1},e.removeMaterial=function(n){var o=e.e.advertiseMaterials;o[n].id&&t.deleMaterials({id:o[n].id}).success(function(){}),e.e.advertiseMaterials.splice(n,1)}}])});