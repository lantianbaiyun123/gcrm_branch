define(["app","../../_common/ytCommon","../../_common/modal/Modal","../../_filters/ContractFilter","../../_filters/AdSolutionTypeFilter","../../_filters/AdSolutionStatusFilter","../../_filters/DatePeriodFilter","../../_directives/ytInputDropdown","anuglar-ui-select2","../../_services/Select2Suggest"],function(t){t.registerController("CtrlAdSolutionList",["$scope","PageSet","AdProgram","Select2Suggest","$filter","Modal","$modal","$state","AdSolutionListConstant","$stateParams","$location","Ad","$window","STATIC_DIR",function(t,e,o,n,a,r,u,i,s,c,d,l,S,m){function p(t){for(var e=!0,o=0;o<t.contentList.length;o++)if("unconfirmed"===t.contentList[o].adSolutionContent.approvalStatus){e=!1;break}return e}var f=a("translate"),g={initQuery:function(){t.queryTypes=s.queryTypes,t.solutionStatus=s.solutionStatus,t.qForm={},t.qForm.queryType=t.queryTypes[0],t.optionCustomer=n.getCustomerOption({placeholder:f("AD_SOLUTION_LIST_PLACEHOLDER_COMPANY_NAME")}),t.pager={pageNumber:1,pageSize:10,pageSizeSlots:[10,20,30,50],totalCount:0},t.queryDate={},c.adNumber&&(t.queryString.adNumber=c.adNumber),c.customerId?t.fromCustomerList=!0:e.set({siteName:"adSolutionList",activeIndex:1})},doQuery:function(){o.getList(this.getQueryParams()).success(function(e){200===e.code&&(t.ads=e.data.result,t.pager.totalCount=e.data.totalCount,t.pager.totalPages=e.data.totalPages)})},getQueryParams:function(){var e=t.qForm,o=e.queryString;return"customerid"===e.queryType.value&&(o=e.customer.data),{cusid:c.customerId,queryType:e.queryType.value,queryStr:o,solutionStatus:e.solutionStatus,pageSize:t.pager.pageSize,pageNumber:t.pager.pageNumber,startDate:a("date")(t.queryDate.startDate,this.dateFormat),endDate:a("date")(t.queryDate.endDate,this.dateFormat)}},dateFormat:"yyyy-MM-dd",resetPageNumber:function(){t.pager.pageNumber=1},clearQueryTypeText:function(){t.queryString.adNumber=null,t.queryString.contractNumber=null,t.queryString.advertiser=null,t.queryString.customer=null}};g.initQuery(),t.setPageSize=function(e){t.pager.pageSize=e,g.resetPageNumber(),g.doQuery()},t.$watch("qForm.queryType",function(e){e&&(t.qForm.customer=void 0,t.qForm.queryString="")}),t.setQueryStatus=function(e){t.queryStatus=t.queryStatusMap[e]},t.toggle=function(t,e){e.showDetail?e.showDetail=!e.showDetail:o.getContentList({id:e.id}).success(function(t){200===t.code&&(t.data.length?(e.contentList=t.data,e.showDetail=!e.showDetail):r.alert({content:s.noContentWarn}))})},t.btnQuery=function(){g.resetPageNumber(),g.doQuery()},t.$watch("pager.pageNumber",function(t){t&&g.doQuery()}),t.optContentScheduleConfirm=function(t,e){l.overdue({id:t.adSolutionContent.id}).success(function(o){200===o.code&&(o.data.overdue?r.confirm({content:f("AD_SOLUTION_DETAIL_WARN_CONFIRM"),psInfo:f("AD_SOLUTION_DETAIL_WARN_CONFIRM_PS")},function(){l.confirmContentSchedule({id:t.adSolutionContent.id,overdue:o.data.overdue}).success(function(o){200===o.code&&r.alert({content:f("AD_SOLUTION_LIST_CONTENT_CONFIRMED")},function(){t.adSolutionContent.approvalStatus="confirmed",t.adSolutionContent.periodDescription=t.schedulePeriod,p(e)&&(e.approval_status="confirmed")})})}):l.confirmContentSchedule({id:t.adSolutionContent.id,overdue:o.data.overdue}).success(function(o){200===o.code&&r.alert({content:f("AD_SOLUTION_LIST_CONTENT_CONFIRMED")},function(){t.adSolutionContent.approvalStatus="confirmed",t.adSolutionContent.periodDescription=t.schedulePeriod,p(e)&&(e.approval_status="confirmed")})}))})},t.optOperatorDetail=function(t){S.open("#/ad2?id="+t.id,"_blank")},t.optProgramChange=function(t){r.confirm({content:a("translate")("AD_SOLUTION_PROGRAM_CHANGE_COMFIRM")+"?"},function(){l.changeAdSolution({id:t.id}).success(function(t){t&&200===t.code&&r.success({content:f("AD_SOLUTION_LIST_AD_CHANGED")},function(){i.go("ad.facade",{programId:t.data.adSolution.id})})})})},t.optOperatorTransfer=function(t){var e=u.open({templateUrl:m+"app/adSolution/list/operatorTransferModal.tpl.html",windowClass:"operator-transfer-modal",controller:["$scope","opts","$modalInstance","Select2Suggest","$filter","Modal","AdProgram",function(e,o,n,a,r,u,i){var s=r("translate");e.title=o.title,e.okText="ok",e.cancelText="cancel",i.findOperator({id:o.adSolutionId}).success(function(t){200===t.code&&(e.originOperator=t.data)}),e.cancel=function(){n.dismiss("cancel")},e.ok=function(){e.stateValidating=!0,e.modalCustomer&&i.operatorChange({adsolutionid:t.id,ucid:e.modalCustomer.ucid,operator:e.modalCustomer.name},function(t){t.data&&200===t.code&&(n.close("ok"),u.success({content:s("AD_SOLUTION_OPERATOR_CHANGE")}))})},e.modalOptionCustomer=a.getOperatorOption({formatSelectionCallback:function(t){e.modalCustomer=t.data}})}],resolve:{opts:function(){return{title:f("AD_SOLUTION_LIST_TRANSFER"),adSolutionId:t.id}}}});e.result.then(function(){g.doQuery()})},t.optPress=function(t){l.press({id:t.id}).success(function(t){200===t.code&&r.success({content:f("AD_SOLUTION_LIST_PRESS_SUCCESS")})})},t.optToCMS=function(t){S.open(t.cmsUrl)}}]),t.registerService("AdSolutionListConstant",["$filter",function(t){var e=t("translate");return{noContentWarn:e("AD_SOLUTION_LIST_NO_CONTENT"),solutionStatus:["saving","approving","refused","approved","unconfirmed","confirmed","cancel"],queryTypes:[{i18nName:e("AD_NUMBER"),value:"number"},{i18nName:e("AD_CONTRACT"),value:"contractnum"},{i18nName:e("ADVERTISER"),value:"advertisers"},{i18nName:e("COMPANY_NAME"),value:"customerid"},{i18nName:e("AD_SOLUTION_LIST_PO"),value:"ponumber"}]}}])});