define(["app","../_directives/ytPositionSelect","../_directives/ytPopoverConfirm","../_directives/ytScrollfix","../_services/http/Publication","../_filters/WeekFilter","../_filters/PositionFilter","./OperateTypeFilter","./ForcePublishModal"],function(e){e.registerController("CtrlPublicationMgmt",["$scope","$stateParams","$log","$filter","$q","$timeout","PageSet","Utils","Modal","PublicationConstant","Publication","ForcePublishModal",function(e,t,r,i,a,n,o,s,u,l,c,p){function d(t){e.isQuery=!0,e.isHistory=!1,e.currentQuery="free",h(S()).then(function(){t&&N()})}function f(){m()}function m(){c.getUserConditions().success(function(t){if(200===t.code){var r=I(),a=i("translate");for(var n in t.data){var o=t.data[n],u={name:a("ALL"),site:{0:{name:a("ALL"),selected:!0}},selected:!0};for(var l in o.platformList){var c=o.platformList[l];for(var p in c.site)u.site[p]?(u.site[p].total=u.site[p].total+c.site[p].total,u.site[p].channel?angular.extend(u.site[p].channel,c.site[p].channel):c.site[p].channel&&(u.site[p].channel=angular.copy(c.site[p].channel))):u.site[p]=angular.copy(c.site[p]);c.site[0]={name:a("ALL"),selected:!0}}o.platformList&&(o.platformList[0]=u),o.platformList&&(o.operate[0].selected=!0),o.dateString=s.getDateString(r[n]);var d=r[n].getDay();d="today"===n?"TODAY":"afterTomorrow"===n?"PUBLICATION_AFTER_TOMORROW":i("WeekFilter")(d,"normal"),o.date=o.dateString.substr(5,5),o.day=i("translate")(d),e.tabset[n]=angular.copy(o),o.platformList&&(e.tabset[n].siteList=angular.copy(o.platformList[0].site)),e.tabset[n].channelList=[],"today"===n&&(e.tabset[n].active=!0)}e.initialized=!0}})}function y(){c.getUserConditions().success(function(t){if(200===t.code)for(var r in t.data){var i=t.data[r],a=e.tabset[r];a.total=i.total;{var n=i.operate;a.operate}for(var o in n)a.operate[o].total=n[o].total;var s=i.platformList,u=a.platformList,l=u[0];for(var c in l.site)l.site[c].total=0;for(var p in s){u[p].total=s[p].total;var d=s[p].site,f=u[p].site;for(var m in d)f[m].total=d[m].total,u[p].selected&&(a.siteList[m].total=d[m].total),l.site[m].total=l.site[m].total+d[m].total}}})}function g(){"free"===e.currentQuery?d():"history"===e.currentQuery?b():e.todoQuery(e.currentQuery)}function h(t){var r=a.defer();return c.getList(t).success(function(t){200===t.code&&(e.pList=t.data.content,e.pager.totalCount=t.data.totalCount,e.pager.totalPages=t.data.totalPages,r.resolve())}),r.promise}function b(){var t=a.defer();return e.initialized&&c.getDoneList(S()).success(function(r){200===r.code&&(e.history.list=r.data.content,e.pager.totalCount=r.data.totalCount,e.pager.totalPages=r.data.totalPages,t.resolve())}),t.promise}function L(t){var r=e.todoQueryForm[t],i={};if(i.pageNumber=e.pager.pageNumber,i.pageSize=e.pager.pageSize,i.operateType=r.operateType,i.productId=r.platformId,i.siteId=r.siteId,r.channelList){for(var a=[],n=r.channelList,o=n.length-1;o>=0;o--)n[o].selected&&a.push(n[o].id);i.channelId=a.join(",")}return i.operateDate=e.tabset[t].dateString,i}function S(){var t={},r=e.qForm;return t.pageNumber=e.pager.pageNumber,t.pageSize=e.pager.pageSize,t.queryType=r.queryType.type,t.queryStr=r.queryString,r.positionSelected&&(t.productId=r.positionSelected.platform&&r.positionSelected.platform.id,t.siteId=r.positionSelected.site&&r.positionSelected.site.id,t.channelId=r.positionSelected.channel&&r.positionSelected.channel.id,t.areaId=r.positionSelected.area&&r.positionSelected.area.id),t}function v(t){e.qForm.queryType=e.qTypes[5],e.qForm.queryString=t,d(!0)}function N(t){for(var r=e.pList.length-1;r>=0;r--)e.pList[r].dateString=t,e.toggleDetail(e.pList[r])}function I(){var e={};return e.today=new Date,e.tomorrow=function(){var e=new Date;return tomorrow=new Date(e.setDate(e.getDate()+1))}(),e.afterTomorrow=function(){var e=new Date;return afterTomorrow=new Date(e.setDate(e.getDate()+2))}(),e}function T(){e.pager.pageNumber=1}o.set({activeIndex:4,siteName:"publicationMgmt"});var C=i("translate");e.qTypes=l.queryTypes,e.positionOpts={level:3},e.currentQuery="today",e.qForm={queryType:e.qTypes[0]},e.tabset={today:{},tomorrow:{},afterTomorrow:{}},e.history={},e.todoQueryForm={today:{operateType:"all"},tomorrow:{operateType:"all"},afterTomorrow:{operateType:"all"}},e.pList=[],e.setOptType=function(t,r){for(var i=e.todoQueryForm[t],a=e.tabset[t].operate,n=e.tabset[t].operate[r],o=a.length-1;o>=0;o--)a[o].selected=!1;n.selected=!0,i.operateType=n.name,e.todoQuery(t)},e.setPlatform=function(t,r){var i=e.todoQueryForm[t],a=e.tabset[t],n=a.platformList,o=n[r];for(var s in n)n[s].selected=!1;o.selected=!0,a.siteList=angular.copy(o.site),a.channelList=[],i.siteId=0,i.channelList=[],i.platformId=r,e.todoQuery(t)},e.setSite=function(t,r){var i=e.todoQueryForm[t],a=e.tabset[t],n=a.siteList,o=n[r],s=o.channel;for(var u in n)n[u].selected=!1;o.selected=!0;var l=a.channelList=[];for(var c in s)l.push({selected:!0,id:c,name:s[c].name});i.channelList=l,i.siteId=r,e.todoQuery(t)},e.notSorted=function(e){return e?Object.keys(e):[]},e.historyQuery=function(){e.isHistory=!0,e.currentQuery="history",T(),b()},e.setQueryType=function(t){e.qForm.queryType=t},e.btnQuery=function(){T(),"history"===e.currentQuery?e.historyQuery():d()},e.todoQuery=function(r){e.isHistory=!1,e.isQuery=!1,e.tabset[r].active=!0,e.currentQuery=r;var i=L(r),a=e.tabset[r].dateString;h(i).then(function(){if(t.applyNumber&&!e.applyNumQueried)v(t.applyNumber),e.applyNumQueried=!0;else if("today"===r)n(function(){N(a)},1e3);else for(var i=e.pList.length-1;i>=0;i--)e.pList[i].dateString=a})},e.toggleDetail=function(e){e.showDetail?e.showDetail=!e.showDetail:c.getDetail({publishNumber:e.number,operateDate:e.dateString}).success(function(t){if(200===t.code){e.detail=t.data;for(var r=e.detail.publishDate,i=r.length-1;i>=0;i--){var a=i+1;r[i].indexText=C("PUBLICATION_PERIOD_INDEX",{index:a})}e.showDetail=!e.showDetail}})},e.toggleDoneDetail=function(e){e.showDetail?e.showDetail=!e.showDetail:c.getDoneDetail({publishNumber:e.number}).success(function(t){200===t.code&&(e.detail=t.data,e.showDetail=!e.showDetail)})},e.pager={pageSize:10,pageSizeSlots:[10,20,30,50],pageNumber:1,totalCount:0},e.setPageSize=function(t){e.pager.pageSize=t,T(),g()},e.$watch("pager.pageNumber",function(e,t){e&&e!==t&&g()}),e.materialUpdate=function(e){c.materialUpdate({number:e}).success(function(e){200===e.code&&(g(),y(),u.success({content:C("SUCCESS_PUBLICATION_MATERIAL_ONLINE"),timeOut:2e3}))})},e.terminateMsg='<p class="text-danger"><strong>'+C("PUBLICATION_TERMINATE_HINT")+"</strong></p>",e.terminate=function(e){c.terminate({number:e}).success(function(e){200===e.code&&(g(),y(),u.success({content:C("SUCCESS_PUBLICATION_TERMINATE"),timeOut:2e3}))})},e.publish=function(e){c.publish({id:e}).success(function(e){200===e.code&&(g(),y(),u.success({content:C("SUCCESS_PUBLICATION_ONLINE"),timeOut:2e3}))})},e.publishFinishBtnClass="btn-primary",e.isEarlyFinish=function(t){var r=new Date;return t.planEnd>r.getTime()?(e.publishFinishMsg='<p class="text-danger"><strong>'+C("PUBLICATION_EARLY_OFFLINE_HINT")+"</strong></p>",e.publishFinishBtnClass="btn-warning"):(e.publishFinishMsg="",e.publishFinishBtnClass="btn-primary"),!0},e.publishFinish=function(e){c.publishFinish({id:e}).success(function(e){200===e.code&&(g(),y(),u.success({content:C("SUCCESS_PUBLICATION_OFFLINE"),timeOut:2e3}))})},e.forcePublish=function(e){p.show({periodId:e},function(e){200===e.code&&(g(),y(),u.success({content:C("SUCCESS_PUBLICATION_FORCE_ONLINE"),timeOut:2e3}))})},e.sendReminder=function(e){c.sendReminder({publishId:e}).success(function(e){200===e.code&&u.success({content:C("SUCCESS_REMIDER"),timeOut:2e3})})},f()}]),e.registerFilter("QueryFilter",function(){return function(e,t,r){return e?"moreEarly"!==r?e:t?e.filter(function(e){for(var r=["adContentNumber","advertisers","number","positionName","scheduleNumber"],i=!1,a=r.length-1;a>=0;a--){var n=r[a];if(i=e[n]&&-1!==e[n].indexOf(t||""))break}return i}):e:void 0}}),e.registerService("PublicationConstant",["$filter",function(e){var t=e("translate");return{queryTypes:[{name:t("AD_NUMBER"),type:"adSolutionNumber"},{name:t("CONTENT_NUMBER"),type:"adContentNumber"},{name:t("SCHEDULE_NUMBER"),type:"scheduleNumber"},{name:t("MATERIAL_NUMBER"),type:"materialNumber"},{name:t("POSITION_NUNBER"),type:"resorucePostionNumber"},{name:t("PUBLICATION_APPLY_NUMBER"),type:"number"}]}}])});