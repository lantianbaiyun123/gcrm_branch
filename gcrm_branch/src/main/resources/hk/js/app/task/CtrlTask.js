define(["app","../_common/ytCommon","../_services/PageSet","../_services/http/Task","../_directives/ytPlaceholder","../_directives/ytInnerHeight","../_directives/ytScrollfix"],function(e){e.registerController("CtrlTask",["$scope","$rootScope","$state","$stateParams","$window","$document","$timeout","$log","$filter","$q","PageSet","Modal","Task",function(e,t,a,s,r,i,o,c,y,n,k,d,p){function T(e,t){if(t.length)if(e.length){for(var a=0,s=0;a<e.length&&s<t.length;){var r=e[a].activityArrivedTime,i=t[s].activityArrivedTime;if(r>i)e.splice(a,1);else if(r===i){var o=e[a].activityId,c=t[s].activityId;c>o?e.splice(a,1):o===c?(a++,s++):o>c&&(e.splice(a,0,t[s]),a++,s++)}else i>r&&(e.splice(a,0,t[s]),a++,s++)}if(a===e.length&&s<t.length){for(t.slice(s);s<t.length;s++)e.push(t[s])}else a<e.length&&s===t.length&&e.splice(a)}else for(var y=0;y<t.length;y++)e.push(t[y]);else e.splice(0)}function f(){var t=-1,a=e.myTask.length,s=!0,r=!0;if(e.taskRecord.foreignKey&&e.taskRecord.activityId){for(var i=0;a>i;i++){if(e.myTask[i].activityId===e.taskRecord.activityId){v(e.myTask[i]),e.taskRecord.index=i,t=i,e.myTask[i].ngClass="selected";break}r&&e.myTask[i].type!==e.taskRecord.type&&(e.otherFirst=e.myTask[i],r=!1)}for(var o=t+1;a>o;o++)if(e.myTask[o].type===e.taskRecord.type&&e.myTask[o].activityArrivedTime<=e.taskRecord.activityArrivedTime?s&&(m(e.myTask[o]),s=!1):r&&e.myTask[o].type!==e.taskRecord.type&&(e.otherFirst=e.myTask[o],r=!1),!s&&!r)return}if(s&&e.taskRecord.type)for(var c=0;a>c;c++)if(e.myTask[c].type===e.taskRecord.type&&e.myTask[c].activityId!==e.taskRecord.activityId?(m(e.myTask[c]),s=!1):r&&e.myTask[c].type!==e.taskRecord.type&&(e.otherFirst=e.myTask[c],r=!1),!s&&!r)return}function l(){for(var t=e.myTask.length,a=0;t>a;a++)if(e.myTask[a].ngClass){e.myTask[a].ngClass="";break}}function v(t){e.taskRecord.activityId=t.activityId,e.taskRecord.taskId=t.activityId,e.taskRecord.processId=t.processId,e.taskRecord.taskName=t.activityName,e.taskRecord.actDefId=t.actDefId,e.taskRecord.foreignName=t.foreignName,e.taskRecord.type=t.type,e.taskRecord.subtype=t.subtype,e.taskRecord.activityArrivedTime=t.activityArrivedTime,e.taskQuery.types[t.type].active=!0}function m(t){e.nextTask.type=t.type,e.nextTask[t.foreignName]=t.foreignKey,e.nextTask.foreignName=t.foreignName,e.nextTask.foreignKey=t.foreignKey,e.nextTask.activityId=t.activityId,e.nextTask.processId=t.processId,e.nextTask.subtype=t.subtype}var u={approval:"task.facade.approval",schedule:"task.facade.schedule",quote:"task.facade.benchmarkPriceApproval",material:"task.facade.materialApproval",customer:"task.facade.customerApproval"};e.taskRecord={},e.nextTask={},e.otherFirst={},e.myTask=[],e.taskRecord.type="",e.taskRecord.activityArrivedTime="",e.taskRecord.autoNext=!1,e.tasksReady=!1,e.taskQuery={queryText:"",taskType:"approval",types:{approval:{name:y("translate")("TASK_TYPE_APPROVAL")},operation:{name:y("translate")("TASK_TYPE_OPERATE")}}},e.updateTask=function(a){e.tasksReady=!1,e.nextTask.foreignKey=null,e.nextTask.activityId=null,e.nextTask.type=null,p.taskGet({},function(s){if(200===s.code)t.myTaskCount=s.data.length,T(e.myTask,s.data),l(),f(),e.tasksReady=!0,a&&e.goNextTask();else{var r="["+s.code+"]"+s.message;d.alert({content:r})}})},e.taskQuery.search=function(t){try{var a=!1,s=!1,r=!1;return t.startUser&&(a=-1!==t.startUser.indexOf(e.taskQuery.queryText||"")),t.processName&&(s=-1!==t.processName.indexOf(e.taskQuery.queryText||"")),t.number&&(r=-1!==t.number.indexOf(e.taskQuery.queryText||"")),!(!(a||s||r)||-1===t.type.indexOf(e.taskQuery.taskType))}catch(i){return!0}},e.goTask=function(t){var s="task.facade.noTask";t.subtype&&(s=u[t.subtype]);var r={};r[t.foreignName]=t.foreignKey,r.activityId=t.activityId,r.processId=t.processId,e.taskQuery.queryText="",a.go(s,r)},e.goNextTask=function(){e.nextTask.type?e.goTask(e.nextTask):a.go("task.facade.noTask")},e.goFirst=function(t){t!==e.taskRecord.type&&e.goTask(e.otherFirst)}}])});