define(["app","anuglar-ui-select2","../_services/Select2Suggest","../_directives/ytPopoverConfirm","./ServiceAdHttp","./ServiceAdBasic","./ServiceAdContent"],function(t){t.registerService("AdSolution",["$q","AdState","AdPrivate","AdHttp","AdBasic","AdContent","PageSet","Select2Suggest",function(t,e,n,i,a,o,s,r){return{init:function(t,n){var o=this;this.initScope(t,n).then(function(){t.solutionId?(s.set({siteName:"adSolutionDetail",activeIndex:1}),i.getDetail({id:t.solutionId}).success(function(n){200===n.code&&(a.initView(t,n.data),t.state.canAddContent=e.canAddContent(t),o.initContents(t,n.data),t.cancelRecord=n.data.cancelRecord,a.updateDirect(t),o.updateState(t))})):(s.set({siteName:"adSolutionAdd",activeIndex:1}),a.initAdd(t),t.state.isGlobleEditing=!0)})},initScope:function(e,i){var a=t.defer(),o=[];return e.solutionId=i,e.basic={},e.adContents=[],o.push(n.getPlatformList(e)),o.push(n.getIndustryTypes(e)),o.push(n.getBillingModel(e)),t.all(o).then(function(){a.resolve()}),e.basic.optionOperator=r.getOperatorOption(),e.basic.optionCustomer=r.getCustomerOption(),e.optionCustomerForAdOwner=r.getCustomerOptionForAdOwner({allowInput:!0}),e.basic.optionContract=r.getContractOption(e),e.state={isGlobleEditing:!1,basicReview:!1,showBasicCancel:!1,disableToApproval:!1,isSolutionTypeUpdate:!1,isDetailView:!1,isAllContentsRefused:!1,isAllContentsSavingRefused:!1,isAnyContentCancel:!1,canAddContent:!0},a.promise},initContents:function(t,e){t.newDetailContents=angular.copy(e.approvalContentViews),t.newDetailContents.length?t.adContents=n.resolveAdData(t.newDetailContents):t.state.canAddContent&&this.addContent(t)},updateState:function(t){t.state.isSolutionTypeUpdate=e.isSolutionTypeUpdate(t),t.state.isAllContentsRefused=e.isAllContentsRefused(t),t.state.isAllContentsSavingRefused=e.isAllContentsSavingRefused(t),t.state.isAnyContentCancel=e.isAnyContentCancel(t),t.state.isDetailView=e.isDetailView(t),t.state.showSolutionAlert=e.showSolutionAlert(t),t.state.canAddContent=e.canAddContent(t),t.state.canSolutionEdit=e.canSolutionEdit(t),t.state.canSolutionChange=e.canSolutionChange(t)},addContent:function(t){t.adContents.push({adSolutionContent:{approvalStatus:"saving"}}),t.state.isGlobleEditing=!0}}}]),t.registerService("AdPrivate",["$q","AdHttp","Position","Industry",function(t,e,n,i){return{getIndustryTypes:function(e){var n=t.defer();return i.getIndustryTypes().success(function(t){if(200===t.code){for(var i={},a=t.data.length,o=0;a>o;o++){var s=t.data[o].industryTypeName;if(i[s]=[],"subIndustryType"in t.data[o])for(var r=t.data[o].subIndustryType.length,d=0;r>d;d++)i[s].push(t.data[o].subIndustryType[d]);else i[s].push(t.data[o])}e.industry={industryTypes:i},n.resolve()}else $log.error("fatal error")}),n.promise},getPlatformList:function(e){var i=t.defer();return n.getPlatformList4Radio().success(function(t){200===t.code&&(e.adPlatformList=t.data,i.resolve())}),i.promise},getBillingModel:function(n){var i=t.defer();return e.getBillingModel().success(function(t){200===t.code&&(n.billingModels=t.data.result,i.resolve())}),i.promise},resolveAdData:function(t){for(var e=[],n=t,i=0;i<n.length;i++){var a=n[i];a.review=!0,a.materialType=~~this.findById(n[i].positionVOList,n[i].adSolutionContent.positionId,"materialType"),a.positionByAreaSelection=n[i].position,a.advertiser={value:n[i].adSolutionContent.advertiser,data:n[i].adSolutionContent.advertiserId},e.push(a)}return e},findById:function(t,e,n){var i=0;if(t=t||[],3==arguments.length){for(;i<t.length;i++)if(t[i].idValue==e)return t[i][n]?t[i][n]:""}else for(;i<t.length;i++)if(t[i].id==id)return t[i]}}}]),t.registerService("AdState",[function(){return{isSolutionTypeUpdate:function(t){return t.basic.adSolution&&"update"===t.basic.adSolution.type},isAllContentsRefused:function(t){var e=!0;if(!t.adContents.length)return!1;for(i=0;i<t.adContents.length;i++){var n=t.adContents[i].adSolutionContent&&t.adContents[i].adSolutionContent.approvalStatus;if("refused"!==n)return e=!1,!1}return e},isAllContentsSavingRefused:function(t){var e=!0;for(i=0;i<t.adContents.length;i++){var n=t.adContents[i].adSolutionContent&&t.adContents[i].adSolutionContent.approvalStatus;if("saving"!==n&&"refused"!==n)return e=!1,!1}return e},isAnyContentCancel:function(t){return t.cancelRecord&&t.cancelRecord.length},isDetailView:function(t){var e=t.basic.solutionStatus||"saving",n=t.state||{};return n.isAnyContentCancel||"saving"!==e&&"refused"!==e||"saving"===e&&!n.isAllContentsSavingRefused||"refused"===e&&!n.isAllContentsRefused},showSolutionAlert:function(t){var e=t.basic.adSolution.contractType&&"Revoked"!==t.basic.adSolution.contractStatus&&!(t.basic.contract&&t.basic.contract.data);return!t.state.isDetailView||t.state.isDetailView&&("approving"===t.basic.adSolution.approvalStatus||"refused"===t.basic.adSolution.approvalStatus||"confirmed"===t.basic.adSolution.approvalStatus&&e)},canAddContent:function(t){return t.BtnIndex.btn_adsol_detail_cont_save&&t.BtnIndex.btn_adsol_detail_submit&&("saving"===t.basic.solutionStatus||"refused"===t.basic.solutionStatus)},canSolutionEdit:function(t){return!(!t.basic.isOwner||!t.BtnIndex.btn_adsol_detail_submit||t.state.isGlobleEditing||t.state.isSolutionTypeUpdate)},canSolutionChange:function(t){return t.basic.isOwner&&t.BtnIndex.btn_adsol_detail_adsol_change&&t.basic.contract.data&&"VALID"==t.basic.contract.data.state&&"confirmed"==t.basic.solutionStatus&&t.basic.contract.data.number&&t.basic.adSolution.contractType&&t.basic.canUpdate}}}]),t.registerService("AdConstant",["$filter",function(t){var e=t("translate");return{terminateWarn:e("AD_SOLUTION_DETAIL_WARN_TERMINATE"),terminatePS:e("AD_SOLUTION_DETAIL_WARN_TERMINATE_PS"),confirmWarn:e("AD_SOLUTION_DETAIL_WARN_CONFIRM"),confirmWarnPS:e("AD_SOLUTION_DETAIL_WARN_CONFIRM_PS"),rescheduleWarn:e("AD_SOLUTION_DETAIL_WARN_RESCHEDULE"),frame:e("AD_SOLUTION_DETAIL_FRAME"),protocol:e("AD_SOLUTION_DETAIL_PROTOCOL"),btnContractTypeSuccess:e("AD_SOLUTION_DETAIL_SUCCESS_SUBMITTED_TO_BUSSINESS"),btnCreatePOSuccess:e("AD_SOLUTION_DETAIL_SUCCESS_CREATED_PO"),rescheduleSuccess:e("AD_SOLUTION_DETAIL_SUCCESS_RESCHEDULE_SEND"),singleContract:e("SINGLE_CONTRACT"),warnAdCancel:e("AD_SOLUTION_DETAIL_WARN_CANCEL_AD"),warnContentCancel:e("AD_SOLUTION_DETAIL_WARN_CANCEL_CONTENT"),successAdCancel:e("AD_SOLUTION_DETAIL_SUCCESS_CANCELED"),successSingleCancel:e("AD_SOLUTION_DETAIL_SUCCESS_CANCELED_SINGLE"),successAdChange:e("AD_SOLUTION_DETAIL_SUCCESS_AD_CHANGE"),POSuccess:e("AD_SOLUTION_DETAIL_PO_SUCCESS"),successChangePO:e("AD_SOLUTION_DETAIL_CHANGE_PO_SUCCESS")}}])});