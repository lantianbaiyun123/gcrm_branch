define(["app","../_common/ytCommon","../_services/PageSet","../_services/http/BenchmarkPrice","../_services/http/BillModel","../_services/http/Industry","../record/BenchmarkPriceApprovalRecord","../record/BenchmarkPriceModifyRecord","../_filters/QuotationStatusFilter","../_filters/BusinessTypeFilter","../_filters/QuotationApprovalStatusFilter","../_filters/PriceTypeFilter"],function(t){t.registerController("CtrlBenchmarkPriceApproval",["$scope","$state","$stateParams","$q","$log","$filter","PageSet","Modal","BenchmarkPrice","BillModel","BenchmarkPriceApprovalRecord","BenchmarkPriceModifyRecord","Industry",function(t,i,o,a,e,n,r,s,u,c,d,l,p){function f(){a.all([m(),I()]).then(function(){v()})}function v(){u.getApprovalInfo({id:t.taskRecord.foreignKey,activityId:t.taskRecord.activityId}).success(function(i){if(200===i.code)y(i.data),t.updateTask();else if(205===i.code){var o="["+i.code+"]"+i.message+"\n";s.alert({content:o})}})}function q(){var i={processId:t.taskRecord.processId,activityId:t.taskRecord.activityId,actDefId:t.taskRecord.actDefId,record:{quoteMainId:t.taskRecord.quoteId,taskId:t.taskRecord.taskId,approvalStatus:t.form.approvalStatus,approvalSuggestion:t.form.approvalSuggestion,processId:t.taskRecord.processId,activityId:t.taskRecord.activityId}};return i}function y(i){t.quotationMain=i.quoteMainView.quotationMainVO.quotationMain,t.quotationMain.platformName=i.quoteMainView.quotationMainVO.platformName,t.quotationMain.siteName=i.quoteMainView.quotationMainVO.siteName,t.quotationMain.createrName=i.quoteMainView.quotationMainVO.createrName,t.quotationList=[{}],M[t.quotationMain.priceType](i.quoteMainView.quotationViewList[0].quotationList),t.quotationList[0].quotationMaterialList=i.quoteMainView.quotationViewList[0].quotationMaterialList,t.quotationList[0].siteId=t.quotationMain.siteId}function m(){var i=a.defer();return c.get({},function(o){if(200===o.code){var a=o.data.result.length;if(a)for(var e=0;a>e;e++)t.constant.billingModel[o.data.result[e].id]=o.data.result[e]}i.resolve()}),i.promise}function I(){var i=a.defer();return p.getIndustryTypes({}).success(function(o){if(200===o.code)for(var a=o.data.length-1;a>=0;a--)t.constant.industryType[o.data[a].id]={industryId:o.data[a].id,industryTypeName:o.data[a].industryTypeName};i.resolve()}),i.promise}r.set({activeIndex:5,siteName:"task"}),t.taskRecord.quoteId=o.quoteId,t.taskRecord.foreignKey=o.quoteId,t.taskRecord.activityId=o.activityId,t.taskRecord.type="approval",t.constant={},t.constant.industryType={},t.constant.billingModel=[],t.submitApproval=function(){if(t.submitDisabble=!0,t.checkApprovalStatus=!0,1!==t.form.approvalStatus&&0!==t.form.approvalStatus)return!1;if(0===t.form.approvalStatus&&(t.checkApprovalSuggestion=!0,!t.form.approvalSuggestion))return!1;var i=q(),o=u.submitApproval(i);o.success(function(i){200===i.code&&s.success({title:n("translate")("APPROVAL_AUDIT_OPINION_SUBMIT_SUCCESS"),content:n("translate")("APPROVAL_SYSTEM_JUMP"),timeOut:3e3},function(){t.goNextTask()})}),o["finally"](function(){t.submitDisabble=!1})};var M={unit:function(i){t.quotationList[0].unit={},t.quotationList[0].unit.cps=[{}];for(var o=i.length,a=0;o>a;a++){var e=t.constant.billingModel[i[a].billingModelId].name.toLowerCase();if("cps"===e)if(i[a].industryId>=0){var n=t.constant.industryType[i[a].industryId].industryTypeName;t.quotationList[0].unit.cps.push({id:i[a].id,industryId:i[a].industryId,value:i[a].ratioMine,name:n})}else t.quotationList[0].unit.cps[0].value=i[a].ratioMine;else t.quotationList[0].unit[e]={},t.quotationList[0].unit[e].id=i[a].id,t.quotationList[0].unit[e].value=i[a].publishPrice}if(t.quotationList[0].unit.cps.length<2){t.quotationList[0].isUnifyedCPS=!0;for(var r in t.constant.industryType){var s={};for(var u in t.constant.industryType[r])s[u]=t.constant.industryType[r][u];t.quotationList[0].unit.cps.push(s)}}},ratio:function(i){t.quotationList[0].ratio={},t.quotationList[0].ratio.id=i[0].id,t.quotationList[0].ratio.ratioMine=i[0].ratioMine,t.quotationList[0].ratio.ratioCustomer=i[0].ratioCustomer,t.quotationList[0].ratio.ratioThird=i[0].ratioThird},rebate:function(i){t.quotationList[0].rebate={},t.quotationList[0].rebate.id=i[0].id,t.quotationList[0].rebate.ratioRebate=i[0].ratioRebate}};f(),t.modalApprovalRecord=function(){d.show(t.taskRecord.quoteId,{windowClass:"benchmark-price-approval-record"})},t.modalModifyRecord=function(){l.show(t.taskRecord.quoteId,{windowClass:"benchmark-price-modify-record"})}}])});