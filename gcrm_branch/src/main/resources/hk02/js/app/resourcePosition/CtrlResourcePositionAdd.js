define(["app","../_common/ytCommon","angular-ui-tree"],function(e){e.registerController("CtrlResourcePositionAdd",["$scope","$log","PageSet","Position","Modal","$state","$stateParams","$filter",function(e,t,a,n,i,o,r,s){var c=s("translate");a.set({siteName:"resourcePositionAdd",activeIndex:2}),e.q={},n.getPlatformListByRole().success(function(t){200===t.code&&(e.q.adPlatformList=t.data,r.platformId&&r.siteId&&(e.q.platformId=r.platformId,e.q.siteId=r.siteId,e.changePlatform(function(){l()})))}),e.changePlatform=function(t){n.getSiteListByRole({adPlatformId:e.q.platformId}).success(function(a){200===a.code&&(e.q.adSiteList=a.data,e.q.siteId=null,e.q.positionTree=null,(t||angular.noop)(),t&&r.siteId&&(e.q.siteId=r.siteId))})},e.changeSite=function(){l()};var l=function(){n.getPositionTree({adPlatformId:e.q.platformId,siteId:e.q.siteId}).success(function(t){200===t.code&&(e.q.positionTree=t.data.posotionData,t.data.posotionData&&t.data.posotionData.length||(e.q.positionTree=[{children:[],isNew:!0}]))})};e.btnSavePosition=function(){e.stateValidating=!0,d()&&n.savePosition({adPlatformId:e.q.platformId,siteId:e.q.siteId,posotionData:e.q.positionTree}).success(function(e){200===e.code&&i.success({content:c("RESOURCE_POSITION_ADD_TREE_SUCCESS")},function(){o.go("resourcePositionList")})})},e.noChinese=function(){var e=/([^\x00-\xff])/g;return{test:function(t){return!e.test(t)}}}();var d=function(){var t=!1,a=!1,n=e.q.positionTree;if(n){for(var i=n.length,o=[],r=0;i>r;r++){var s=n[r],c=!1;if(s.i18nData&&s.i18nData.cnName&&s.i18nData.enName){for(var l=0;l<o.length;l++)(o[l].cnName===s.i18nData.cnName||o[l].enName===s.i18nData.enName)&&(c=!0);c?(s.isDuplicate=!0,t=!0):(s.isDuplicate=!1,o.push({cnName:s.i18nData.cnName,enName:s.i18nData.enName}))}else s.isDuplicate=!1,a=!0;var d=n[r].children;if(!d)break;for(var u=d.length,f=[],m=0;u>m;m++){var N=d[m],D=!1;if(N.i18nData&&N.i18nData.cnName&&N.i18nData.enName){for(var p=0;p<f.length;p++)(f[p].cnName===N.i18nData.cnName||f[p].enName===N.i18nData.enName)&&(D=!0);D?(N.isDuplicate=!0,t=!0):(N.isDuplicate=!1,f.push({cnName:N.i18nData.cnName,enName:N.i18nData.enName}))}else N.isDuplicate=!1,a=!0;var h=d[m].children;if(!h)break;for(var g=h.length,v=[],I=0;g>I;I++){var P=h[I],q=!1;if(P.i18nData&&P.i18nData.cnName&&P.i18nData.enName){for(var S=0;S<v.length;S++)(v[S].cnName===P.i18nData.cnName||v[S].enName===P.i18nData.enName)&&(q=!0);q?(P.isDuplicate=!0,t=!0):(P.isDuplicate=!1,v.push({cnName:P.i18nData.cnName,enName:P.i18nData.enName}))}else P.isDuplicate=!1,a=!0}}}return!t&&!a}};e.inputKeyup=function(){e.stateValidating&&d()},e.treeOptions={accept:function(e,t){return e.depth()===t.depth()+1}},e.removeNodeCustom=function(e){u(e)};var u=function(e){f(e)?e.remove():i.alert({content:c("RESOURCE_POSITION_ADD_REMOVE_NOT_ALLOWED")})},f=function N(e){if(!e)return!1;if(!e.$modelValue.isNew)return!1;if(!e.childNodes().length)return!0;for(var t=0;t<e.childNodes().length;t++)return N(e.childNodes()[t]);return!1};e.toggle=function(e){e.toggle()},e.addChannel=function(t){e.stateValidating=!1,t.unshift({children:[],isNew:!0})},e.addArea=function(t){e.stateValidating=!1,m(t)},e.addPosition=function(t){e.stateValidating=!1,m(t)};var m=function(e){var t=e.$modelValue;t.children=t.children||[],t.children.unshift({children:[],isNew:!0})}}])});