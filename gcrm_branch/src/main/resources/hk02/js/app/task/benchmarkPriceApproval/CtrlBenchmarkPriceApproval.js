define(["app","../../_common/ytCommon","../../_services/PageSet","../../_services/http/BenchmarkPrice","../../_services/http/BillModel","../../_services/http/Industry","../../record/BenchmarkPriceApprovalRecord","../../record/BenchmarkPriceModifyRecord","../../_filters/QuotationStatusFilter","../../_filters/BusinessTypeFilter","../../_filters/QuotationApprovalStatusFilter","../../_filters/PriceTypeFilter"],function(t){t.registerController("CtrlBenchmarkPriceApproval",["$scope","$state","$stateParams","$q","$log","$filter","PageSet","Modal","BenchmarkPrice","BillModel","BenchmarkPriceApprovalRecord","BenchmarkPriceModifyRecord","Industry",function(t,i,e,a,o,n,r,s,u,d,c,l,p){function f(){a.all([y(),I()]).then(function(){v()})}function v(){u.getApprovalInfo({id:t.taskRecord.foreignKey,activityId:t.taskRecord.activityId}).success(function(i){if(200===i.code)m(i.data),t.updateTask();else if(205===i.code){var e="["+i.code+"]"+i.message+"\n";s.alert({content:e})}else t.updateTask()})}function q(){var i={processId:t.taskRecord.processId,activityId:t.taskRecord.activityId,actDefId:t.taskRecord.actDefId,record:{quoteMainId:t.taskRecord.quoteId,taskId:t.taskRecord.taskId,approvalStatus:t.form.approvalStatus,approvalSuggestion:t.form.approvalSuggestion,processId:t.taskRecord.processId,activityId:t.taskRecord.activityId}};return i}function m(i){t.quotationMain=i.quoteMainView.quotationMainVO.quotationMain,t.quotationMain.platformName=i.quoteMainView.quotationMainVO.platformName,t.quotationMain.siteName=i.quoteMainView.quotationMainVO.siteName,t.quotationMain.createrName=i.quoteMainView.quotationMainVO.createrName,t.quotationList=[{}],M[t.quotationMain.priceType](i.quoteMainView.quotationViewList[0].quotationList),t.quotationList[0].quotationMaterialList=i.quoteMainView.quotationViewList[0].quotationMaterialList,t.quotationList[0].siteId=t.quotationMain.siteId}function y(){var i=a.defer();return d.get({},function(e){if(200===e.code){var a=e.data.result.length;if(a)for(var o=0;a>o;o++)t.constant.billingModel[e.data.result[o].id]=e.data.result[o]}i.resolve()}),i.promise}function I(){var i=a.defer();return p.getIndustryTypes({}).success(function(e){if(200===e.code){for(var a={},o=e.data.length,n=0;o>n;n++){var r=e.data[n],s=r.id,u=r.industryTypeName;if("subIndustryType"in r)for(var d=r.subIndustryType,c=(d.length,0);o>c;c++)d[c].parentId=s,d[c].parentName=u,a[d[c].id]=d[c];else r.parentId=s,r.parentName=u,a[r.id]=r}t.constant.industryType=a}i.resolve()}),i.promise}r.set({activeIndex:5,siteName:"task"}),t.taskRecord.quoteId=e.quoteId,t.taskRecord.foreignKey=e.quoteId,t.taskRecord.activityId=e.activityId,t.taskRecord.type="approval",t.constant={},t.constant.industryType={},t.constant.billingModel=[],t.submitApproval=function(){if(t.submitDisabble=!0,t.checkApprovalStatus=!0,1!==t.form.approvalStatus&&0!==t.form.approvalStatus)return!1;if(0===t.form.approvalStatus&&(t.checkApprovalSuggestion=!0,!t.form.approvalSuggestion))return!1;var i=q(),e=u.submitApproval(i);e.success(function(i){200===i.code&&s.success({title:n("translate")("APPROVAL_AUDIT_OPINION_SUBMIT_SUCCESS"),content:n("translate")("APPROVAL_SYSTEM_JUMP"),timeOut:3e3},function(){t.goNextTask()})}),e["finally"](function(){t.submitDisabble=!1})};var M={unit:function(i){t.quotationList[0].unit={},t.quotationList[0].unit.cps=[{}];for(var e=i.length,a=0;e>a;a++){var n=t.constant.billingModel[i[a].billingModelId].name.toLowerCase();if("cps"===n)if(i[a].industryId>=0){var r=t.constant.industryType[i[a].industryId].industryTypeName,s=t.constant.industryType[i[a].industryId].parentId;t.quotationList[0].unit.cps.push({id:i[a].id,industryId:i[a].industryId,value:i[a].ratioMine,industryTypeName:r,parentId:s})}else t.quotationList[0].unit.cps[0].value=i[a].ratioMine,t.quotationList[0].isUnifyedCPS=!0;else t.quotationList[0].unit[n]={},t.quotationList[0].unit[n].id=i[a].id,t.quotationList[0].unit[n].value=i[a].publishPrice}o.info(t.quotationList[0].unit.cps[0])},ratio:function(i){t.quotationList[0].ratio={},t.quotationList[0].ratio.id=i[0].id,t.quotationList[0].ratio.ratioMine=i[0].ratioMine,t.quotationList[0].ratio.ratioCustomer=i[0].ratioCustomer,t.quotationList[0].ratio.ratioThird=i[0].ratioThird},rebate:function(i){t.quotationList[0].rebate={},t.quotationList[0].rebate.id=i[0].id,t.quotationList[0].rebate.ratioRebate=i[0].ratioRebate}};f(),t.modalApprovalRecord=function(){c.show(t.taskRecord.quoteId,{windowClass:"benchmark-price-approval-record"})},t.modalModifyRecord=function(){l.show(t.taskRecord.quoteId,{windowClass:"benchmark-price-modify-record"})}}])});