define(["app","../../_services/http/Schedules","../../_directives/ytSchedulePopoverConfirm","../../_directives/ytScheduleTable","../../_directives/ytBusySpin","../../_directives/periodLabel","../../_directives/ytCheckboxIndeterminate","../../_filters/MonthShortFilter","../../_filters/MonthMiniFilter","../../_filters/RotationTypeFilter","../../_filters/DatePeriodFilter"],function(t){t.registerFactory("ScheduleModal",["$modal","$timeout","$filter","AdProgram","STATIC_DIR",function(t,e,n,s,a){return{show:function(e,s){var d={title:n("translate")("SCHEDULE_MODAL")},i=t.open({templateUrl:a+"app/task/schedule/scheduleModal.tpl.html",controller:"CtrlScheduleModal",windowClass:"schedule-modal",backdrop:"static",resolve:{opts:function(){return angular.extend(d,e)}}});i.result.then(function(t){"goNext"===t&&s()})}}}]),t.registerController("CtrlScheduleModal",["$scope","$modalInstance","$log","$filter","$q","$timeout","Schedules","opts",function(t,e,n,s,a,d,i,o){function c(e,n){var s=e+"-"+n;if(t.scheduleList[e].days[n].checkbox&&t.scheduleList[e].days[n].checked^t.scheduleList[e].days[n].originalChecked)t.scheduleList[e].days[n].changed="changed",t.changedArr.push(s);else{t.scheduleList[e].days[n].changed="";for(var a=t.changedArr.length-1;a>=0;a--)t.changedArr[a]===s&&t.changedArr.splice(a,1)}}function r(){l(),t.busySpinShow=!0;var e=u(k);e.then(function(){}),e["finally"](function(){t.busySpinShow=!1})}function h(e){for(var n=t.monthList.length-1;n>=0;n--)t.monthList[n].active=!1;t.monthList[e].active=!0,t.activeYear=t.monthList[e].year,t.$$phase||t.$apply()}function l(){var e=b.getMonth()+1,n=b.getFullYear(),s=0;endIndex=-1;for(var a=0;13>a;a++){var d=e+a,i=n,o=d+1,c=n,r=s,h=endIndex+1;d>12&&(d-=12,i+=1),o>12&&(o-=12,c+=1);var l=10>d?"0"+d:d,u=10>o?"0"+o:o,y=c+"-"+u+"-01 00:00:00",f=x(y),p=Math.ceil((f-b)/1e3/60/60/24);s=42*p,endIndex=p-1;var v=f;v.setHours(v.getHours()-24),t.monthList.push({year:i,num:d,monthString:i+"-"+l,lastDay:v,startIndex:h,endIndex:endIndex,startPosition:r,endPosition:s})}t.monthList[0].active=!0}function u(e,n){{var s,o=a.defer();t.thDays.length}if(t.thDays.length&&!n)s=t.thDays[t.thDays.length-1].dateString;else{var c=t.today.date;c.setDate(c.getDate()-1),s=f(c).dateString}return n||y(e),i.getScheduleInfo({adContentId:t.positionInfo.adContentId,positionId:t.positionInfo.positionId,startDate:s,days:e}).success(function(n){if(200===n.code&&n.data&&n.data.allDates){var s=n.data.allDates;if(p(s),n.data.scheduleList&&n.data.scheduleList.length)for(var a=n.data.scheduleList.length-1;a>=0;a--)K.adContent=n.data.scheduleList[a],K.adContentKey=n.data.scheduleList[a].id||"current",K.checkExist(),K.expendDays(e),K.updateCheckbox(),K.updateOccupy(n.data.occupyStartIndex,n.data.occupyEndIndex),"confirmed"!==n.data.scheduleList[a].state&&"locked"!==n.data.scheduleList[a].state&&K.updateInsert(n.data.insertStartIndex,n.data.insertEndIndex),"current"===K.adContentKey&&(t.currentAllowInsert=K.adContent.allowInsertDates),K.initMonthCheckbox();else v(e),t.noSchedule=!0;d(function(){o.resolve()},0)}else v(e),d(function(){o.resolve()},0)}),o.promise}function y(e){var n=t.thDays.length,s=new Date;n&&(s=new Date(t.thDays[n-1].dateString),s.setHours(s.getHours()+24));for(var a=0;e>a;a++)t.thDays.push(f(s)),s.setHours(s.getHours()+24);t.$$phase||t.$apply()}function f(t){t=t||new Date;var e={},n=t.getFullYear(),a=t.getMonth()+1,d=t.getDate();return e.dayYear=n,e.dayMonth=a,e.dayNo=d,e.alreadyCount=0,e.checkCount=0,e.monthText=a,1===e.dayNo&&(e.dayNo=s("translate")(s("MonthMiniFilter")(a))),a=10>a?"0"+a:a,d=10>d?"0"+d:d,e.dateString=n+"-"+a+"-"+d,e}function p(e){for(var n in e){var s=new Date(e[n].date);tdIndex=Math.ceil((s-b)/1e3/60/60/24),0>tdIndex||t.thDays[tdIndex]&&(t.thDays[tdIndex].dateId=n,t.thDays[tdIndex].isInsertDate=e[n].insertDate,t.thDays[tdIndex].total=e[n].totalAmount,t.dayState[n]={thDaysIndex:tdIndex,isInsertDate:e[n].insertDate})}}function v(e){for(var n in t.scheduleList)for(var s=t.scheduleList[n].days.length,a=0;e>a;a++)t.scheduleList[n].days.push({checkbox:!1,dateString:t.thDays[s+a].dateString})}function g(e,n){var s=!0,a=!0,d=!0;t.scheduleList[e].monthCheckbox[n.monthIndex].disabled=!1;for(var i=n.start;i<=n.end;i++)t.scheduleList[e].days[i]&&t.scheduleList[e].days[i].checkbox&&(s=!1,t.scheduleList[e].days[i].checked?d=!1:t.scheduleList[e].days[i].checkbox&&(a=!1)),("confirmed"===t.scheduleList[e].state||"locked"===t.scheduleList[e].state)&&(t.scheduleList[e].monthCheckbox[n.monthIndex].disabled=!0);s?(t.scheduleList[e].monthCheckbox[n.monthIndex].checked=!1,t.scheduleList[e].monthCheckbox[n.monthIndex].indeterminate=!1,t.scheduleList[e].monthCheckbox[n.monthIndex].disabled=!0):a?(t.scheduleList[e].monthCheckbox[n.monthIndex].checked=!0,t.scheduleList[e].monthCheckbox[n.monthIndex].indeterminate=!1):d?(t.scheduleList[e].monthCheckbox[n.monthIndex].checked=!1,t.scheduleList[e].monthCheckbox[n.monthIndex].indeterminate=!1):(t.scheduleList[e].monthCheckbox[n.monthIndex].checked=!1,t.scheduleList[e].monthCheckbox[n.monthIndex].indeterminate=!0)}function C(e){for(var n,s,a,d=e.substr(0,7),i=t.monthList.length,o=0;i>o;o++)if(t.monthList[o].monthString===d){n=o,s=t.monthList[o].startIndex,a=t.monthList[o].endIndex;break}return{monthIndex:n,start:s,end:a}}function I(){for(var e=t.thDays.length-1;e>=0;e--)t.thDays[e].checkCount=0;var n={processId:t.processInfo&&t.processInfo.processId,activityId:t.processInfo&&t.processInfo.activityId,adContentId:t.positionInfo.adContentId,positionId:t.positionInfo.positionId,advertiser:t.positionInfo.advertiser,startDate:t.today.yesterday,days:t.thDays.length,endDate:m(),scheduleDates:[],conflictInfos:[]};for(var s in t.scheduleList)if("reserved"===t.scheduleList[s].state||"current"===s){var a={adContentId:t.scheduleList[s].adContentId,positionId:t.scheduleList[s].positionId,occupyDates:[],insertDates:[],allowInsertDates:[]};"current"!==s&&(t.scheduleList[s].checked=!1);for(var d=t.scheduleList[s].days.length-1;d>=0;d--)!t.scheduleList[s].checked&&t.scheduleList[s].days[d].checked^t.scheduleList[s].days[d].originalChecked&&(t.scheduleList[s].checked=!0),t.scheduleList[s].days[d].checkbox&&t.scheduleList[s].days[d].checked&&(t.scheduleList[s].days[d].isInsert?a.insertDates.push(t.thDays[d].dateId):a.occupyDates.push(t.thDays[d].dateId),t.thDays[d].checkCount++);"current"!==s?a.id=s:(a.occupyDates=a.occupyDates.concat(t.currentOccupyDatesTail),a.insertDates=a.insertDates.concat(t.currentInsertDatesTail),a.allowInsertDates=t.currentAllowInsert,a.advertiser=t.scheduleList[s].advertiser),(t.scheduleList[s].checked||"current"===s)&&n.scheduleDates.push(a)}for(var i=t.thDays.length-1;i>=0;i--)if(t.thDays[i].checkCount+t.thDays[i].alreadyCount>t.thDays[i].total){var o={date:t.thDays[i].dateString,contentIds:[]};for(s in t.scheduleList)t.scheduleList[s].days[i].checked&&o.contentIds.push(t.scheduleList[s].adContentId);n.conflictInfos.push(o)}return n}function m(){for(var e=t.thDays[t.thDays.length-1].dateString,n=t.thDays.length-1;n>=0;n--)if(t.thDays[n].dateId){e=t.thDays[n].dateString;break}return e}function D(){var e=a.defer();return t.submitData=I(),i.validateSchedule(t.submitData).success(function(t){200===t.code?e.resolve(t.data):e.resolve()}),e.promise}function L(){var e=a.defer();return i.submitSchedule(t.submitData).success(function(t){200===t.code&&e.resolve(t.data)}),e.promise}function x(t){var e=t.split(" "),n=e[0].split("-"),s=e[1].split(":"),a=new Date;return a.setUTCFullYear(n[0],n[1]-1,n[2]),a.setUTCHours(Number(s[0]),Number(s[1]),0,0),a}var b=new Date,k=62,S={reserved:"success",confirmed:"danger",locked:"muted",expect:"info"};t.today={date:new Date,dateString:f(this.date).dateString,yesterday:function(){var t=new Date;return yesterdayDate=new Date(t.setDate(t.getDate()-1)),f(yesterdayDate).dateString}()},t.current={},t.showConfirm=o.showConfirm||!1,t.modalDatas=o.modalDatas,t.readOnly=o.readOnly,t.activeYear=b.getFullYear(),t.monthList=[],t.activeMonthPosition=0,t.busySpinShow=!1,t.thDays=[],t.dayState={},t.scheduleList={},t.positionInfo=o.positionInfo,t.processInfo=o.processInfo,t.currentOccupyDatesTail=[],t.currentInsertDatesTail=[],t.currentAllowInsert=[],t.submitData={},t.legendShow=!1,t.suspendMsgs=[],t.warningMsgs=[],t.submitMsgs=[],t.currentContent={},r(),t.selectMonth=function(e,n){var s=t.thDays.length,a=Math.ceil((e.lastDay-b)/1e3/60/60/24)+1,i=a-s;if(t.busySpinShow=!0,h(n),s>=a)t.activeMonthPosition=t.monthList[n].startPosition,d(function(){t.activeMonthPosition=-1}),t.busySpinShow=!1;else{var o=u(i);o.then(function(){t.activeMonthPosition=t.monthList[n].startPosition,d(function(){t.activeMonthPosition=-1})}),o["finally"](function(){t.busySpinShow=!1})}},t.changeMonthCheckbox=function(e,n,s){e.stopPropagation();var a=t.monthList[n].startIndex,d=t.monthList[n].endIndex,i=t.scheduleList[s].monthCheckbox[n].checked;t.scheduleList[s].monthCheckbox[n].indeterminate=!1;for(var o=a;d>=o;o++)t.scheduleList[s].days[o].checked=!i,t.scheduleList[s].days[o].changed=t.scheduleList[s].days[o].checkbox&&t.scheduleList[s].days[o].checked^t.scheduleList[s].days[o].originalChecked?"changed":"";t.scheduleList[s].checked=!0},t.scrollSetMonth=function(e){for(var n=t.monthList.length,s=0;n>s;s++)if(e>=t.monthList[s].startPosition&&e<t.monthList[s].endPosition){h(s);break}},t.loadMore=function(){if(t.busySpinShow)return!1;var e=k,n=t.thDays.length,s=Math.ceil((t.monthList[t.monthList.length-1].lastDay-b)/1e3/60/60/24)+1;if(n+e>=s&&(e=s-n),e>0){var a=u(e);a.then(function(){}),a["finally"](function(){}),t.$apply()}},t.reloadSchedule=function(){var e=t.thDays.length,n=e;t.busySpinShow=!0,t.scheduleList={};for(var s=t.thDays.length-1;s>=0;s--)t.thDays[s].alreadyCount=0;var a=u(n,!0);a.then(function(){}),a["finally"](function(){t.busySpinShow=!1})},t.ownerClicked=function(e){for(var n in t.scheduleList)t.scheduleList[n].selected=n!==e?!1:!0};var M,w,A;t.dayClicked=function(e,n,s){if(s&&M>=0&&M!==e&&A===n){var a=M,d=e;M>e&&(a=e,d=M);for(var i=a;d>i;i++)t.scheduleList[n].days[i].checkbox&&(t.scheduleList[n].days[i].checked=w,c(n,i))}e>=0&&(M=e,A=n,w=t.scheduleList[n].days[e].checked,c(n,e),t.scheduleList[n].checked=!0);var o=C(t.scheduleList[n].days[e].dateString);g(n,o)},t.nextAlways=o.nextAlways,t.changedArr=[],t.confirm=function(){t.busySpinShow=!0;var n=L();n.then(function(){e.close("goNext")}),n["finally"](function(){t.busySpinShow=!1})},t.cancel=function(){e.dismiss("cancel")},t.next=function(){$.emptyMsg(),t.busySpinShow=!0;var e=D();e.then(function(t){t&&$[t.state](t)}),e["finally"](function(){t.busySpinShow=!1})},t.nextOk=function(){t.showConfirm=!0,t.popoverConfirmShow=!1},t.nextCancel=function(){t.popoverConfirmShow=!1},t.prev=function(){t.showConfirm=!1},t.closeAlert=function(e){t.suspendMsgs.splice(e,1)},t.showLegend=function(){t.legendShow=!t.legendShow};var K={adContent:{},adContentKey:"",checkExist:function(){t.scheduleList[this.adContentKey]||(t.scheduleList[this.adContentKey]={adContentId:this.adContent.adContentId,billingModelId:this.adContent.billingModelId,positionId:this.adContent.positionId,state:this.adContent.state,adContentNumber:this.adContent.adContentNumber,adContentName:this.adContent.adContentName,advertiser:this.adContent.advertiser,operator:this.adContent.operator,monthCheckbox:[],ngClass:"current"===this.adContentKey?"current selected":this.adContent.state,days:[]},this.adContent.id?t.scheduleList[this.adContentKey].scheduleId=this.adContent.id:(t.scheduleList[this.adContentKey].selected=!0,t.scheduleList[this.adContentKey].checked=!0,t.current.advertiser=this.adContent.advertiser,t.current.operator=this.adContent.operator));for(var e=0;13>e;e++)t.scheduleList[this.adContentKey].monthCheckbox.push({checked:!1,indeterminate:!1})},expendDays:function(e){for(var n=t.scheduleList[this.adContentKey]?t.scheduleList[this.adContentKey].days.length:0,s=0;e>s;s++){var a={};a.dateString=t.thDays[n+s].dateString,t.thDays[n+s].isInsertDate||"confirmed"===t.scheduleList[this.adContentKey].state||"locked"===t.scheduleList[this.adContentKey].state||t.readOnly?a.checkbox=!1:t.thDays[n+s].dateId&&(a.checkbox=!0),t.readOnly&&(a.disabled=!0),t.scheduleList[this.adContentKey].days.push(a)}},updateCheckbox:function(){var e=(this.adContent,this.adContentKey),n=this.adContent.allowInsertDates;if(n&&n.length)for(var s=n.length-1;s>=0;s--)if(t.dayState[n[s]]){var a=t.dayState[n[s]].thDaysIndex;t.scheduleList[e]&&(t.scheduleList[e].days[a].checkbox=!0)}},updateOccupy:function(e,n){if(this.adContent.occupyDates&&this.adContent.occupyDates.length){var s=[];"current"===this.adContentKey?(e>-1&&n>=e&&(s=this.adContent.occupyDates.slice(e,n+1)),t.currentOccupyDatesTail=this.adContent.occupyDates.slice(n+1)):s=this.adContent.occupyDates,this.updateTds(s)}},updateInsert:function(e,n){if(this.adContent.insertDates&&this.adContent.insertDates.length){var s=[];"current"===this.adContentKey?(e>-1&&n>=e&&(s=this.adContent.insertDates.slice(e,n+1)),t.currentInsertDatesTail=this.adContent.insertDates.slice(n+1)):s=this.adContent.insertDates,this.updateTds(s,!0)}},updateTds:function(e,n){var s=this.adContent,a=this.adContentKey;if(e.length)for(var d=e.length-1;d>=0;d--){var i=t.dayState[e[d]];if(i){var o=i.thDaysIndex;t.scheduleList[a]&&(n||"current"===a||(t.scheduleList[a].days[o].checkbox=!0),t.scheduleList[a].days[o].checkbox&&(t.scheduleList[a].days[o].checked=!0,t.scheduleList[a].days[o].originalChecked=!0,n||"confirmed"!==t.scheduleList[this.adContentKey].state&&"locked"!==t.scheduleList[this.adContentKey].state||t.thDays[o].alreadyCount++,"current"!==a&&(t.scheduleList[a].days[o].ngClass=S[s.state])),"current"===a&&(t.scheduleList[a].days[o].ngClass=S.expect),("confirmed"===s.state||"locked"===s.state||t.readOnly)&&(t.scheduleList[a].days[o].disabled=!0),n&&(t.scheduleList[a].days[o].isInsert=!0))}}},initMonthCheckbox:function(){for(var e=0;13>e;e++){var n={monthIndex:e,start:t.monthList[e].startIndex,end:t.monthList[e].endIndex};g(this.adContentKey,n)}}},$={emptyMsg:function(){t.suspendMsgs=[],t.submitMsgs=[],t.warningMsgs=[]},prepareValidateMsg:function(e){var n={};if(e&&e.length)for(var s=e.length,a=0;s>a;a++){if(n[e[a].type]||(n[e[a].type]=[]),e[a].conflictAdvertiser&&e[a].conflictAdvertiser.length){e[a].conflictAdvertisers=[];for(var d=e[a].conflictAdvertiser.length-1;d>=0;d--){var i={name:e[a].conflictAdvertiser[d]};d===e[a].curIndex&&(i.isCurrent=!0),e[a].conflictAdvertisers.push(i)}}"overdue"===e[a].type&&(e[a].advertiser=t.current.advertiser,e[a].operator=t.current.operator),n[e[a].type].push(e[a])}return n},warning:function(e){t.warningMsgs=e.validateMsg,t.submitMsgs=e.submitMsg,t.$$phase||t.$apply(),this.prependSubmitData(e.submitMsg),t.popoverConfirmShow=!0},suspend:function(e){if(t.suspendMsgs=[],e.validateMsg&&e.validateMsg.length){var n=this.prepareValidateMsg(e.validateMsg);t.suspendMsgs[0]=n,t.currentContent.currentAdvertiser=e.currentAdvertiser}},success:function(e){t.submitMsgs=e.submitMsg,this.prependSubmitData(e.submitMsg),t.showConfirm=!0},prependSubmitData:function(e){for(var n=e.length-1;n>=0;n--)if(e[n].oldOccupyIds&&e[n].oldOccupyIds.length||e[n].oldInsertIds&&e[n].oldInsertIds.length)for(var s=t.submitData.scheduleDates,a=s.length-1;a>=0;a--)s[a].adContentId===e[n].adContentId&&(s[a].oldOccupyIds=e[n].oldOccupyIds,s[a].oldInsertIds=e[n].oldInsertIds)}}}])});